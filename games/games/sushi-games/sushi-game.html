<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oishii Sushi</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background: #0a0605;
        }

        /* Main scene with perspective */
        .scene {
            perspective: 1200px;
            perspective-origin: 50% 30%;
            min-height: 100vh;
            overflow: visible;
        }

        /* Restaurant interior - the back wall */
        .restaurant {
            min-height: 100vh;
            background:
                /* Warm ambient lighting from ceiling */
                radial-gradient(ellipse at 50% -20%, rgba(255, 180, 120, 0.4) 0%, transparent 60%),
                radial-gradient(ellipse at 20% 10%, rgba(255, 100, 50, 0.2) 0%, transparent 30%),
                radial-gradient(ellipse at 80% 10%, rgba(255, 100, 50, 0.2) 0%, transparent 30%),
                /* Wood panel wall */
                linear-gradient(180deg,
                    #1a0f0a 0%,
                    #2c1810 15%,
                    #3d2317 30%,
                    #4a2c1c 50%,
                    #3d2317 70%,
                    #2c1810 100%
                );
            position: relative;
            padding-bottom: 40px;
            transform-style: preserve-3d;
        }

        /* Wood grain texture overlay */
        .restaurant::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 150px,
                    rgba(0,0,0,0.15) 150px,
                    rgba(0,0,0,0.15) 152px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent 0px,
                    rgba(139, 90, 43, 0.03) 3px,
                    transparent 6px
                );
            pointer-events: none;
        }

        /* Ceiling beam */
        .ceiling {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 15px;
            background: linear-gradient(180deg, #0a0605 0%, #1a0f0a 100%);
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* Hanging lanterns decoration */
        .lanterns {
            display: flex;
            justify-content: space-around;
            padding: 25px 60px 20px;
            position: relative;
            transform: translateZ(50px);
        }

        .lantern {
            width: 45px;
            height: 65px;
            background: linear-gradient(180deg, #cc0000 0%, #990000 50%, #660000 100%);
            border-radius: 50% 50% 45% 45%;
            position: relative;
            box-shadow:
                0 0 40px rgba(255, 100, 50, 0.6),
                0 0 80px rgba(255, 100, 50, 0.4),
                0 0 120px rgba(255, 80, 30, 0.2),
                inset 0 -10px 20px rgba(0,0,0,0.3);
            animation: lanternGlow 3s ease-in-out infinite alternate;
        }

        @keyframes lanternGlow {
            0% { box-shadow: 0 0 40px rgba(255, 100, 50, 0.6), 0 0 80px rgba(255, 100, 50, 0.4), 0 0 120px rgba(255, 80, 30, 0.2), inset 0 -10px 20px rgba(0,0,0,0.3); }
            100% { box-shadow: 0 0 50px rgba(255, 120, 60, 0.7), 0 0 100px rgba(255, 120, 60, 0.5), 0 0 150px rgba(255, 100, 40, 0.3), inset 0 -10px 20px rgba(0,0,0,0.3); }
        }

        .lantern::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #1a1a1a, #333);
        }

        .lantern::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 15px;
            background: linear-gradient(180deg, #990000, #ffcc00);
            border-radius: 0 0 3px 3px;
        }

        /* Restaurant name sign */
        .restaurant-sign {
            text-align: center;
            margin-bottom: 15px;
            transform: translateZ(30px);
        }

        .sign-board {
            display: inline-block;
            background: linear-gradient(180deg, #1a0f0a 0%, #2c1810 50%, #1a0f0a 100%);
            padding: 12px 35px;
            border-radius: 5px;
            border: 4px solid #8b5a2b;
            box-shadow:
                0 8px 30px rgba(0,0,0,0.6),
                inset 0 2px 10px rgba(255,200,150,0.1);
        }

        .restaurant-name {
            font-size: 28px;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8), 0 0 20px rgba(255, 200, 100, 0.3);
            letter-spacing: 3px;
        }

        .restaurant-subtitle {
            color: #d4a574;
            font-size: 11px;
            margin-top: 3px;
            letter-spacing: 2px;
        }

        /* Counter area wrapper with 3D transform */
        .counter-wrapper {
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        /* Main counter area */
        .counter-area {
            width: 1500px;
            max-width: 1500px;
            margin: 0 auto;
            padding: 0 20px;
            transform-style: preserve-3d;
        }

        /* The actual counter surface with perspective */
        .counter-surface {
            transform: rotateX(25deg) translateZ(20px);
            transform-style: preserve-3d;
            transform-origin: center top;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            justify-content: center;
        }

        /* Sushi counter - realistic wood */
        .sushi-counter {
            background:
                /* Wood grain highlight */
                linear-gradient(90deg,
                    rgba(255,255,255,0) 0%,
                    rgba(255,255,255,0.08) 50%,
                    rgba(255,255,255,0) 100%
                ),
                /* Main wood color */
                linear-gradient(180deg,
                    #d4b896 0%,
                    #c9a66b 5%,
                    #b8956a 15%,
                    #a67c52 40%,
                    #8b6914 70%,
                    #7a5a12 100%
                );
            border-radius: 8px 8px 20px 20px;
            padding: 25px 30px 30px;
            box-shadow:
                0 30px 60px rgba(0,0,0,0.6),
                0 10px 30px rgba(0,0,0,0.4),
                inset 0 2px 3px rgba(255,255,255,0.4),
                inset 0 -8px 20px rgba(0,0,0,0.3);
            border: 4px solid #5d4037;
            border-top: 6px solid #a67c52;
            position: relative;
            overflow: visible;
            transform-style: preserve-3d;
        }

        /* Counter front edge - adds depth */
        .sushi-counter::after {
            content: '';
            position: absolute;
            bottom: -25px;
            left: -4px;
            right: -4px;
            height: 25px;
            background: linear-gradient(180deg, #5d4037 0%, #3d2317 50%, #2c1810 100%);
            border-radius: 0 0 20px 20px;
            transform: rotateX(-90deg);
            transform-origin: top;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Wood grain texture */
        .sushi-counter::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                repeating-linear-gradient(
                    92deg,
                    transparent 0px,
                    transparent 50px,
                    rgba(139, 90, 43, 0.12) 50px,
                    rgba(139, 90, 43, 0.12) 52px,
                    transparent 52px,
                    transparent 100px,
                    rgba(139, 90, 43, 0.08) 100px,
                    rgba(139, 90, 43, 0.08) 101px
                ),
                repeating-linear-gradient(
                    88deg,
                    transparent 0px,
                    transparent 70px,
                    rgba(0, 0, 0, 0.04) 70px,
                    rgba(0, 0, 0, 0.04) 72px
                );
            pointer-events: none;
            border-radius: 5px;
        }

        .counter-label {
            text-align: center;
            color: #3d2317;
            font-weight: 700;
            font-size: 11px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 1px 1px 0 rgba(255,255,255,0.4);
            position: relative;
            z-index: 1;
        }

        /* Realistic bamboo rolling mat */
        .bamboo-mat {
            background:
                repeating-linear-gradient(
                    90deg,
                    #9ab34a 0px,
                    #8fbc8f 2px,
                    #7aa35d 4px,
                    #6b8e23 6px,
                    #5a7a1e 7px,
                    #6b8e23 8px,
                    #7aa35d 10px,
                    #8fbc8f 12px,
                    #9ab34a 14px
                );
            border-radius: 6px;
            padding: 20px 25px;
            margin-bottom: 20px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow:
                inset 0 4px 15px rgba(0,0,0,0.5),
                0 5px 20px rgba(0,0,0,0.4);
            border: 3px solid #3d5c1a;
            position: relative;
            z-index: 1;
        }

        /* Mat binding strings */
        .bamboo-mat::before,
        .bamboo-mat::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg,
                transparent 0%,
                #6b5344 5%,
                #d4a574 8%,
                #8b7355 12%,
                #6b5344 15%,
                transparent 20%,
                transparent 80%,
                #6b5344 85%,
                #8b7355 88%,
                #d4a574 92%,
                #6b5344 95%,
                transparent 100%
            );
        }

        .bamboo-mat::before { top: 6px; }
        .bamboo-mat::after { bottom: 6px; }

        .flat-roll {
            width: 100%;
            max-width: 380px;
            min-height: 50px;
            display: flex;
            flex-direction: column-reverse;
            border-radius: 6px;
            overflow: visible;
            background: transparent;
            position: relative;
        }

        .layer {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
            animation: stackUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            letter-spacing: 0.5px;
        }

        @keyframes stackUp {
            0% {
                transform: translateY(30px) scale(0.9);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Seaweed - dark green nori sheet with texture */
        .layer.seaweed {
            height: 12px;
            background:
                repeating-linear-gradient(
                    90deg,
                    rgba(0,0,0,0.1) 0px,
                    transparent 1px,
                    transparent 3px
                ),
                repeating-linear-gradient(
                    0deg,
                    rgba(0,0,0,0.05) 0px,
                    transparent 1px,
                    transparent 2px
                ),
                linear-gradient(90deg, #0a1a0a 0%, #142814 20%, #1a3a1a 50%, #142814 80%, #0a1a0a 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        /* Rice - white fluffy texture with grain pattern */
        .layer.rice {
            height: 22px;
            background:
                radial-gradient(ellipse 3px 2px at 10% 30%, rgba(0,0,0,0.03) 0%, transparent 100%),
                radial-gradient(ellipse 2px 3px at 25% 70%, rgba(0,0,0,0.03) 0%, transparent 100%),
                radial-gradient(ellipse 3px 2px at 40% 40%, rgba(0,0,0,0.03) 0%, transparent 100%),
                radial-gradient(ellipse 2px 2px at 55% 60%, rgba(0,0,0,0.03) 0%, transparent 100%),
                radial-gradient(ellipse 3px 3px at 70% 35%, rgba(0,0,0,0.03) 0%, transparent 100%),
                radial-gradient(ellipse 2px 2px at 85% 65%, rgba(0,0,0,0.03) 0%, transparent 100%),
                linear-gradient(180deg, #ffffff 0%, #f8f6f2 30%, #f5f2ed 70%, #f0ebe5 100%);
            border-radius: 4px;
            box-shadow:
                0 3px 6px rgba(0,0,0,0.25),
                inset 0 2px 4px rgba(255,255,255,0.9),
                inset 0 -2px 4px rgba(0,0,0,0.05);
            color: #888;
            text-shadow: none;
            margin-top: -2px;
        }

        /* Avocado - creamy green with subtle variation */
        .layer.avocado {
            height: 14px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.15) 20%,
                    rgba(255,255,255,0.2) 50%,
                    rgba(255,255,255,0.15) 80%,
                    transparent 100%
                ),
                linear-gradient(180deg, #7ab317 0%, #6a9f15 40%, #5a8a12 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 2px 3px rgba(255,255,255,0.3),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            margin-top: -1px;
        }

        /* Cucumber - light green with seed pattern */
        .layer.cucumber {
            height: 12px;
            background:
                radial-gradient(ellipse 2px 1px at 15% 50%, rgba(200,230,180,0.6) 0%, transparent 100%),
                radial-gradient(ellipse 2px 1px at 35% 50%, rgba(200,230,180,0.6) 0%, transparent 100%),
                radial-gradient(ellipse 2px 1px at 55% 50%, rgba(200,230,180,0.6) 0%, transparent 100%),
                radial-gradient(ellipse 2px 1px at 75% 50%, rgba(200,230,180,0.6) 0%, transparent 100%),
                linear-gradient(180deg, #8fce52 0%, #7abc45 40%, #6aaa38 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 2px 3px rgba(255,255,255,0.4),
                inset 0 -1px 2px rgba(0,0,0,0.15);
            margin-top: -1px;
        }

        /* Mango - bright orange-yellow with glossy look */
        .layer.mango {
            height: 14px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.3) 30%,
                    rgba(255,255,255,0.4) 50%,
                    rgba(255,255,255,0.3) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #ffcc4d 0%, #f5a623 40%, #e8941c 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 3px 5px rgba(255,255,255,0.5),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            color: #7a4a10;
            text-shadow: 0 1px 0 rgba(255,255,255,0.3);
            margin-top: -1px;
        }

        /* Cream Cheese - slightly off-white creamy look */
        .layer.creamcheese {
            height: 12px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.5) 30%,
                    rgba(255,255,255,0.6) 50%,
                    rgba(255,255,255,0.5) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #fffef8 0%, #f8f4e8 40%, #f0ead8 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.2),
                inset 0 2px 4px rgba(255,255,255,0.8),
                inset 0 -1px 2px rgba(0,0,0,0.1);
            margin-top: -1px;
        }

        /* Pumpkin - vibrant orange */
        .layer.pumpkin {
            height: 14px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.3) 30%,
                    rgba(255,255,255,0.4) 50%,
                    rgba(255,255,255,0.3) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #ff8c42 0%, #ff7518 40%, #e86400 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 3px 5px rgba(255,255,255,0.4),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            margin-top: -1px;
        }

        /* Mushroom - earthy brown */
        .layer.mushroom {
            height: 12px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.2) 30%,
                    rgba(255,255,255,0.3) 50%,
                    rgba(255,255,255,0.2) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #a08070 0%, #8b7355 40%, #6b5344 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            margin-top: -1px;
        }

        /* Jalapeno - spicy green */
        .layer.jalapeno {
            height: 12px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.3) 30%,
                    rgba(255,255,255,0.4) 50%,
                    rgba(255,255,255,0.3) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #32cd32 0%, #228b22 40%, #1a6b1a 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 2px 4px rgba(255,255,255,0.4),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            margin-top: -1px;
        }

        /* Pepper - red bell pepper */
        .layer.pepper {
            height: 14px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.3) 30%,
                    rgba(255,255,255,0.4) 50%,
                    rgba(255,255,255,0.3) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #ff6666 0%, #ff4444 40%, #cc3333 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 5px rgba(0,0,0,0.3),
                inset 0 3px 5px rgba(255,255,255,0.4),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            margin-top: -1px;
        }

        /* Ultimate - golden star */
        .layer.ultimate {
            height: 16px;
            background:
                linear-gradient(90deg,
                    transparent 0%,
                    rgba(255,255,255,0.5) 30%,
                    rgba(255,255,255,0.7) 50%,
                    rgba(255,255,255,0.5) 70%,
                    transparent 100%
                ),
                linear-gradient(180deg, #ffec8b 0%, #ffd700 40%, #daa520 100%);
            border-radius: 3px;
            box-shadow:
                0 2px 8px rgba(255,215,0,0.6),
                inset 0 3px 6px rgba(255,255,255,0.6),
                inset 0 -1px 2px rgba(0,0,0,0.2);
            margin-top: -1px;
        }

        /* Hover tooltip for layers */
        .layer::after {
            content: attr(data-ingredient);
            position: absolute;
            right: -70px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            text-transform: capitalize;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .layer:hover::after {
            opacity: 1;
        }

        .layer:hover {
            filter: brightness(1.1);
        }

        /* Rolled sushi display */
        .rolled-sushi {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: plateSlide 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            padding: 15px 0;
        }

        @keyframes plateSlide {
            0% {
                transform: translateY(30px) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Black rectangular sushi plate */
        .sushi-plate {
            width: 240px;
            height: 100px;
            background:
                radial-gradient(ellipse at 30% 30%, rgba(60,60,60,1) 0%, transparent 50%),
                linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 40%, #0a0a0a 100%);
            border-radius: 8px;
            position: relative;
            box-shadow:
                0 12px 35px rgba(0,0,0,0.5),
                0 4px 15px rgba(0,0,0,0.3),
                inset 0 1px 2px rgba(255,255,255,0.1),
                inset 0 -3px 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Plate subtle rim */
        .sushi-plate::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            bottom: 3px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.08);
            pointer-events: none;
        }

        /* Plate sheen */
        .sushi-plate::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 15px;
            right: 15px;
            height: 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, transparent 100%);
            border-radius: 4px;
            pointer-events: none;
        }

        /* The long sushi roll container */
        .sushi-roll-container {
            position: relative;
            width: 180px;
            height: 50px;
            animation: rollAppear 0.6s ease-out 0.3s backwards;
        }

        @keyframes rollAppear {
            0% {
                transform: translateY(20px) scale(0.8);
                opacity: 0;
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* The cylindrical roll body */
        .sushi-roll {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(180deg,
                    #0a150a 0%,
                    #101f10 8%,
                    #182b18 18%,
                    #1f3a1f 30%,
                    #264a26 45%,
                    #2d5a2d 50%,
                    #264a26 55%,
                    #1f3a1f 70%,
                    #182b18 82%,
                    #101f10 92%,
                    #0a150a 100%
                );
            border-radius: 25px;
            box-shadow:
                0 8px 25px rgba(0,0,0,0.5),
                inset 0 4px 10px rgba(255,255,255,0.08),
                inset 0 -5px 12px rgba(0,0,0,0.5);
        }

        /* Nori texture */
        .sushi-roll::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                repeating-linear-gradient(
                    90deg,
                    rgba(0,0,0,0.02) 0px,
                    transparent 1px,
                    transparent 6px
                ),
                repeating-linear-gradient(
                    0deg,
                    rgba(255,255,255,0.01) 0px,
                    transparent 1px,
                    transparent 4px
                );
            border-radius: 25px;
            pointer-events: none;
        }

        /* Highlight on top of roll */
        .sushi-roll::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 20px;
            right: 20px;
            height: 12px;
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            border-radius: 6px;
            pointer-events: none;
        }

        /* Cross section (end of roll) - oval shape integrated into the roll */
        .sushi-end {
            position: absolute;
            right: 0;
            top: 0;
            width: 35px;
            height: 50px;
            border-radius: 0 25px 25px 0;
            background:
                radial-gradient(ellipse at 50% 45%, rgba(255,255,255,0.12) 0%, transparent 40%),
                linear-gradient(180deg,
                    #0a150a 0%,
                    #142814 15%,
                    #1a3a1a 35%,
                    #1f4520 50%,
                    #1a3a1a 65%,
                    #142814 85%,
                    #0a150a 100%
                );
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                inset -3px 0 8px rgba(0,0,0,0.4),
                inset 0 3px 6px rgba(255,255,255,0.05),
                inset 0 -3px 8px rgba(0,0,0,0.4);
        }

        /* Rice ring - oval to match the perspective */
        .sushi-rice-ring {
            width: 26px;
            height: 38px;
            border-radius: 50%;
            background:
                radial-gradient(ellipse at 45% 40%, rgba(255,255,255,0.98) 0%, transparent 55%),
                linear-gradient(180deg, #ffffff 0%, #f8f5f0 40%, #f0ebe3 70%, #e8e0d5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow:
                inset 0 3px 8px rgba(0,0,0,0.1),
                inset 0 -2px 5px rgba(255,255,255,0.9);
        }

        /* Fillings in the center - pie chart style */
        .sushi-fillings {
            width: 18px;
            height: 26px;
            border-radius: 50%;
            position: relative;
            box-shadow:
                inset 0 2px 4px rgba(0,0,0,0.15),
                inset 0 -1px 3px rgba(255,255,255,0.3);
            overflow: hidden;
        }

        /* Pie chart will be set dynamically via JS */
        .sushi-fillings-pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        /* Decorative wasabi and ginger */
        .plate-garnish {
            position: absolute;
            bottom: 12px;
            left: 18px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1;
        }

        .wasabi {
            width: 16px;
            height: 12px;
            background: radial-gradient(ellipse at 50% 30%, #a5d24a, #7ab317);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        .ginger {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ginger-slice {
            width: 20px;
            height: 5px;
            background: linear-gradient(90deg, #ffb6c1, #ffc8d0, #ffb6c1);
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .ginger-slice:nth-child(2) {
            width: 18px;
            margin-left: 2px;
        }

        .ginger-slice:nth-child(3) {
            width: 16px;
            margin-left: 3px;
        }

        /* Make sushi draggable */
        .sushi-roll-container.draggable {
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .sushi-roll-container.draggable:hover {
            transform: scale(1.05);
        }

        .sushi-roll-container.dragging {
            cursor: grabbing;
            opacity: 0.8;
            transform: scale(1.1);
            z-index: 1000;
        }

        /* Coin display */
        .coin-display {
            background: linear-gradient(180deg, #ffd700 0%, #ffaa00 100%);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 800;
            color: #5d3a1a;
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.5), inset 0 2px 4px rgba(255,255,255,0.4);
            border: 2px solid #cc8800;
            margin-top: 10px;
        }

        .coin-icon {
            font-size: 18px;
        }

        /* Level display */
        .level-display {
            background: linear-gradient(180deg, #9c27b0 0%, #7b1fa2 100%);
            padding: 8px 12px;
            border-radius: 15px;
            text-align: center;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
            border: 2px solid #6a1b9a;
        }

        .level-label {
            font-size: 9px;
            color: #e1bee7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-number {
            font-size: 20px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .level-progress {
            margin-top: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }

        .level-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #e1bee7, #f3e5f5);
            border-radius: 10px;
            transition: width 0.3s ease-out;
        }

        .level-progress-text {
            font-size: 8px;
            color: #e1bee7;
            margin-top: 3px;
        }

        /* Shop button */
        .shop-btn {
            margin-top: 10px;
            padding: 10px 20px;
            background: linear-gradient(180deg, #ff9800 0%, #f57c00 100%);
            border: 2px solid #e65100;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            transition: all 0.2s;
        }

        .shop-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
        }

        /* Shop popup */
        .shop-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .shop-popup {
            background: linear-gradient(180deg, #fff 0%, #f5f5f5 100%);
            border-radius: 20px;
            padding: 25px;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border: 3px solid #ff9800;
        }

        .shop-title {
            font-size: 24px;
            font-weight: 800;
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #fff;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
        }

        .shop-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shop-item-icon {
            font-size: 28px;
        }

        .shop-item-details {
            display: flex;
            flex-direction: column;
        }

        .shop-item-name {
            font-weight: 700;
            color: #333;
            font-size: 14px;
        }

        .shop-item-owned {
            font-size: 11px;
            color: #666;
        }

        .shop-item-price {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: #f57c00;
        }

        .shop-buy-btn {
            padding: 8px 16px;
            background: linear-gradient(180deg, #4CAF50 0%, #388E3C 100%);
            border: 2px solid #2E7D32;
            border-radius: 15px;
            color: white;
            font-weight: 700;
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
        }

        .shop-buy-btn:hover {
            transform: translateY(-2px);
        }

        .shop-buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .shop-close-btn {
            display: block;
            margin: 15px auto 0;
            padding: 10px 30px;
            background: linear-gradient(180deg, #666 0%, #444 100%);
            border: 2px solid #333;
            border-radius: 20px;
            color: white;
            font-weight: 700;
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
        }

        .shop-item.owned {
            background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: #4CAF50;
        }

        .shop-section {
            font-size: 12px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 15px 0 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .shop-section:first-of-type {
            margin-top: 5px;
        }

        .upgrade-btn {
            margin-left: 5px;
            padding: 6px 10px;
            font-size: 10px;
            background: linear-gradient(180deg, #ff9800 0%, #f57c00 100%);
            border: 2px solid #e65100;
        }

        .upgrade-btn:hover:not(:disabled) {
            background: linear-gradient(180deg, #ffb74d 0%, #ff9800 100%);
        }

        /* Level up animation */
        .level-up-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #9c27b0 0%, #6a1b9a 100%);
            padding: 30px 50px;
            border-radius: 20px;
            border: 4px solid #e1bee7;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            animation: levelUpPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes levelUpPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .level-up-title {
            font-size: 28px;
            font-weight: 800;
            color: #ffd700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .level-up-number {
            font-size: 48px;
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .level-up-info {
            font-size: 12px;
            color: #e1bee7;
            margin-top: 10px;
        }

        /* Order timer bar */
        .order-timer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }

        .order-timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 0 0 8px 8px;
            transition: width 0.1s linear;
        }

        .order-timer-bar.warning {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .order-timer-bar.critical {
            background: linear-gradient(90deg, #f44336, #FF5722);
            animation: timerPulse 0.5s ease-in-out infinite;
        }

        @keyframes timerPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .order-expired {
            animation: orderExpire 0.5s ease-out forwards;
        }

        @keyframes orderExpire {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); background: linear-gradient(180deg, #5a2a2a, #3a1a1a); }
            100% { transform: scale(0.8); opacity: 0; }
        }

        /* Customer area */
        .customer-area {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
        }

        .customer {
            display: flex;
            align-items: center;
            gap: 15px;
            animation: customerBounce 2s ease-in-out infinite;
        }

        @keyframes customerBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .customer-face {
            --hair-color: #2a1a0a;
            width: 70px;
            height: 70px;
            background: linear-gradient(180deg, #ffdbac 0%, #f0c08a 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Hair on top */
        .customer-face::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -5px;
            width: 80px;
            height: 40px;
            background: var(--hair-color);
            border-radius: 50% 50% 0 0;
            z-index: -1;
        }

        /* Eyes */
        .customer-eyes {
            position: absolute;
            top: 22px;
            left: 15px;
            width: 10px;
            height: 10px;
            background: #2a1a0a;
            border-radius: 50%;
            box-shadow: 30px 0 0 #2a1a0a;
        }

        /* Blush */
        .customer-eyes::before {
            content: '';
            position: absolute;
            top: 12px;
            left: -5px;
            width: 12px;
            height: 6px;
            background: rgba(255, 150, 150, 0.5);
            border-radius: 50%;
            box-shadow: 38px 0 0 rgba(255, 150, 150, 0.5);
        }

        /* Smile */
        .customer-mouth {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            border: 3px solid #c97878;
            border-top: none;
            border-radius: 0 0 20px 20px;
            background: transparent;
        }

        /* Speech bubble */
        .speech-bubble {
            background: white;
            border-radius: 20px;
            padding: 12px 15px;
            min-width: 100px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 3px solid #e0e0e0;
            position: relative;
            transition: all 0.3s;
        }

        .speech-bubble::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 50%;
            transform: translateY(-50%);
            border: 10px solid transparent;
            border-right-color: white;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            border: 12px solid transparent;
            border-right-color: #e0e0e0;
            z-index: -1;
        }

        .speech-bubble.drag-over {
            background: #e8ffe8;
            border-color: #4CAF50;
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
        }

        .order-request {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 600;
        }

        /* Mini sushi preview in speech bubble */
        .order-sushi {
            width: 70px;
            height: 22px;
            background: linear-gradient(180deg, #0a150a 0%, #1a3a1a 30%, #2d5a2d 50%, #1a3a1a 70%, #0a150a 100%);
            border-radius: 11px;
            position: relative;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            margin: 0 auto;
        }

        .order-sushi-end {
            position: absolute;
            right: 0;
            top: 0;
            width: 14px;
            height: 22px;
            border-radius: 0 11px 11px 0;
            background: linear-gradient(180deg, #0a150a 0%, #1a3a1a 30%, #1f4520 50%, #1a3a1a 70%, #0a150a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .order-rice-ring {
            width: 10px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(180deg, #fff 0%, #f0ebe3 50%, #e8e0d5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .order-fillings {
            width: 6px;
            height: 10px;
            border-radius: 50%;
            overflow: hidden;
        }

        .order-fillings-pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: #7ab317;
        }

        /* Happy customer */
        .customer.happy {
            animation: customerHappy 0.5s ease-out;
        }

        @keyframes customerHappy {
            0% { transform: scale(1); }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1); }
        }

        /* Payment popup */
        .payment-popup {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #ffd700 0%, #ffaa00 100%);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 800;
            color: #5d3a1a;
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.5);
            animation: paymentFloat 1s ease-out forwards;
            z-index: 100;
            white-space: nowrap;
        }

        @keyframes paymentFloat {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-40px); }
        }

        /* Call customer button */
        .call-customer-btn {
            margin-top: 10px;
            padding: 10px 15px;
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
            border: 2px solid #cc4444;
            border-radius: 15px;
            font-family: 'Nunito', sans-serif;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(200, 50, 50, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .call-customer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(200, 50, 50, 0.5);
        }

        .call-customer-btn:active {
            transform: translateY(0);
        }

        /* Bento storage box */
        .storage-area {
            flex-shrink: 0;
        }

        .bento-box {
            width: 110px;
            background:
                linear-gradient(180deg, #8b4513 0%, #6b3410 50%, #5a2d0e 100%);
            border-radius: 8px;
            padding: 8px;
            box-shadow:
                0 8px 30px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.1),
                inset 0 -3px 8px rgba(0,0,0,0.3);
            border: 3px solid #4a2409;
        }

        .bento-label {
            text-align: center;
            color: #ffd700;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .bento-interior {
            background:
                linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-radius: 4px;
            min-height: 150px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
            box-shadow:
                inset 0 3px 10px rgba(0,0,0,0.5);
            border: 2px solid #2a2a2a;
            transition: background 0.3s, box-shadow 0.3s;
        }

        .bento-interior.drag-over {
            background: linear-gradient(180deg, #2a3a2a 0%, #1a2a1a 100%);
            box-shadow:
                inset 0 3px 10px rgba(0,0,0,0.5),
                inset 0 0 20px rgba(100, 200, 100, 0.2);
        }

        .bento-empty {
            color: #555;
            font-size: 10px;
            text-align: center;
            padding: 20px 5px;
            font-style: italic;
        }

        /* Mini sushi in bento box */
        .bento-sushi {
            width: 85px;
            height: 20px;
            background:
                linear-gradient(180deg,
                    #0a150a 0%,
                    #1a3a1a 30%,
                    #2d5a2d 50%,
                    #1a3a1a 70%,
                    #0a150a 100%
                );
            border-radius: 10px;
            position: relative;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            animation: bentoAdd 0.3s ease-out;
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .bento-sushi:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .bento-sushi.dragging {
            cursor: grabbing;
            opacity: 0.6;
            transform: scale(1.1);
        }

        @keyframes bentoAdd {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .bento-sushi-end {
            position: absolute;
            right: 0;
            top: 0;
            width: 14px;
            height: 20px;
            border-radius: 0 10px 10px 0;
            background:
                linear-gradient(180deg,
                    #0a150a 0%,
                    #1a3a1a 30%,
                    #1f4520 50%,
                    #1a3a1a 70%,
                    #0a150a 100%
                );
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bento-rice-ring {
            width: 10px;
            height: 16px;
            border-radius: 50%;
            background: linear-gradient(180deg, #fff 0%, #f0ebe3 50%, #e8e0d5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bento-fillings {
            width: 6px;
            height: 10px;
            border-radius: 50%;
            overflow: hidden;
        }

        /* Workspace drop zone highlight */
        .bamboo-mat.drag-over {
            box-shadow:
                inset 0 4px 15px rgba(0,0,0,0.5),
                0 5px 20px rgba(0,0,0,0.4),
                0 0 30px rgba(100, 200, 100, 0.4);
        }

        .bento-fillings-pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        /* Bento counter */
        .bento-count {
            text-align: center;
            color: #d4a574;
            font-size: 9px;
            margin-top: 8px;
            font-weight: 600;
        }

        /* Ingredient side panels */
        .ingredient-side {
            background: linear-gradient(180deg, #3d2317 0%, #2c1810 100%);
            border-radius: 10px;
            padding: 15px 10px;
            min-width: 90px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 3px solid #5d4037;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .side-label {
            color: #ffd700;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Prep stations area */
        .prep-stations-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            min-height: 180px;
        }

        .prep-station {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .prep-label {
            font-size: 10px;
            color: #d4a574;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Rice Cooker */
        .rice-cooker {
            position: relative;
        }

        .cooker-body {
            position: relative;
            width: 80px;
        }

        .cooker-lid {
            width: 70px;
            height: 25px;
            background: linear-gradient(180deg, #e0e0e0 0%, #b0b0b0 50%, #909090 100%);
            border-radius: 35px 35px 0 0;
            margin: 0 auto;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
            position: relative;
        }

        .cooker-lid::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 15px;
            height: 8px;
            background: linear-gradient(180deg, #666, #444);
            border-radius: 4px;
        }

        .cooker-bowl {
            width: 80px;
            height: 50px;
            background: linear-gradient(180deg, #f5f5f5 0%, #e0e0e0 50%, #c0c0c0 100%);
            border-radius: 5px 5px 20px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.2), 0 5px 15px rgba(0,0,0,0.3);
            border: 2px solid #999;
            transition: all 0.3s;
        }

        .cooker-bowl.drag-over {
            background: linear-gradient(180deg, #fff8e0 0%, #ffe0a0 50%, #ffc060 100%);
            box-shadow: inset 0 5px 15px rgba(0,0,0,0.2), 0 0 20px rgba(255, 200, 100, 0.5);
        }

        .cooker-bowl.cooking {
            background: linear-gradient(180deg, #fff 0%, #ffe0a0 50%, #ffb050 100%);
            animation: cookingPulse 0.5s ease-in-out infinite;
        }

        @keyframes cookingPulse {
            0%, 100% { box-shadow: inset 0 5px 15px rgba(0,0,0,0.2), 0 0 15px rgba(255, 150, 50, 0.4); }
            50% { box-shadow: inset 0 5px 15px rgba(0,0,0,0.2), 0 0 25px rgba(255, 150, 50, 0.7); }
        }

        .cooker-empty {
            font-size: 9px;
            color: #888;
            text-align: center;
            padding: 5px;
        }

        .cooker-base {
            width: 75px;
            height: 10px;
            background: linear-gradient(180deg, #444 0%, #222 100%);
            border-radius: 0 0 5px 5px;
            margin: 0 auto;
        }

        .cooking-timer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: 800;
            color: #ff6600;
            text-shadow: 0 0 10px rgba(255, 100, 0, 0.8);
        }

        .cooked-rice-output {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 30px;
            align-items: center;
        }

        /* Chopping Board */
        .chopping-board {
            position: relative;
        }

        .board-surface {
            width: 100px;
            height: 60px;
            background:
                repeating-linear-gradient(90deg, #d4a574 0px, #c9956a 3px, #d4a574 6px),
                linear-gradient(180deg, #d4a574 0%, #b8845a 100%);
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 2px 5px rgba(255,255,255,0.3);
            border: 3px solid #8b5a2b;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .board-surface.drag-over {
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 0 20px rgba(100, 200, 100, 0.5);
            border-color: #4CAF50;
        }

        .board-empty {
            font-size: 9px;
            color: #6b4423;
            text-align: center;
            padding: 5px;
        }

        .chopping-item {
            font-size: 28px;
            animation: choppingBounce 0.2s ease-in-out infinite;
        }

        @keyframes choppingBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.9); }
        }

        .board-surface.chopping {
            background: linear-gradient(180deg, #e8d4b4 0%, #d4b894 100%);
        }

        .knife {
            width: 60px;
            height: 12px;
            background: linear-gradient(180deg, #e0e0e0 0%, #a0a0a0 40%, #606060 100%);
            border-radius: 2px 15px 15px 2px;
            position: relative;
            margin-top: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .knife::before {
            content: '';
            position: absolute;
            left: -15px;
            top: -3px;
            width: 20px;
            height: 18px;
            background: linear-gradient(180deg, #4a3520 0%, #2a1a10 100%);
            border-radius: 3px;
        }

        .chopped-output {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 30px;
            margin-top: 5px;
            align-items: center;
        }

        /* Prepared ingredient chips */
        .prepared-item {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .prepared-item:hover {
            transform: scale(1.1);
        }

        .prepared-item.cooked-rice {
            background: linear-gradient(180deg, #fff 0%, #f0ebe3 100%);
            color: #6b4423;
            border: 2px solid #d4a574;
        }

        .prepared-item.chopped {
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .prepared-item.chopped.avocado {
            background: linear-gradient(180deg, #7ab317 0%, #5a8a12 100%);
            border: 2px solid #4a7a0a;
        }

        .prepared-item.chopped.cucumber {
            background: linear-gradient(180deg, #8bc34a 0%, #6aa038 100%);
            border: 2px solid #5a9030;
        }

        .prepared-item.chopped.mango {
            background: linear-gradient(180deg, #ffcc4d 0%, #e8941c 100%);
            border: 2px solid #d08010;
            color: #5d3a1a;
        }

        .prepared-item.chopped.creamcheese {
            background: linear-gradient(180deg, #fffef8 0%, #f0ead8 100%);
            border: 2px solid #e0d8c0;
            color: #5d4a3a;
            text-shadow: none;
        }

        .prepared-item.chopped.pumpkin {
            background: linear-gradient(180deg, #ff8c42 0%, #e86400 100%);
            border: 2px solid #cc5800;
        }

        .prepared-item.chopped.mushroom {
            background: linear-gradient(180deg, #a08070 0%, #6b5344 100%);
            border: 2px solid #5a4030;
        }

        .prepared-item.chopped.jalapeno {
            background: linear-gradient(180deg, #32cd32 0%, #1a6b1a 100%);
            border: 2px solid #145a14;
        }

        .prepared-item.chopped.pepper {
            background: linear-gradient(180deg, #ff6666 0%, #cc3333 100%);
            border: 2px solid #aa2222;
        }

        .prepared-item.chopped.ultimate {
            background: linear-gradient(180deg, #ffd700 0%, #daa520 100%);
            border: 2px solid #b8860b;
            color: #4a3800;
            text-shadow: none;
        }

        /* Draggable raw ingredient */
        .draggable-ingredient {
            cursor: grab;
        }

        .draggable-ingredient:active {
            cursor: grabbing;
        }

        .draggable-ingredient.dragging {
            opacity: 0.5;
        }

        @keyframes chopAnimation {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(-5deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        /* Ingredients display - like items on the counter */
        .ingredients-display {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .ingredient {
            width: 72px;
            height: 82px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            transform-style: preserve-3d;
        }

        .ingredient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(180deg, rgba(255,255,255,0.5), transparent);
            border-radius: 12px 12px 50% 50%;
            pointer-events: none;
        }

        .ingredient:hover {
            transform: translateY(-10px) scale(1.08);
        }

        .ingredient:active {
            transform: translateY(-5px) scale(1.04);
        }

        .ingredient .icon {
            font-size: 32px;
            margin-bottom: 4px;
            filter: drop-shadow(2px 3px 3px rgba(0,0,0,0.4));
        }

        .ingredient .count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .ingredient.out-of-stock {
            filter: grayscale(0.5);
            opacity: 0.8;
        }

        .ingredient.out-of-stock .icon {
            font-size: 20px;
        }

        .ingredient .buy-label {
            font-size: 9px;
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .ingredient .buy-price {
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        /* Buy popup */
        .buy-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .buy-popup {
            background: linear-gradient(180deg, #3d2317 0%, #2c1810 100%);
            border: 4px solid #8b5a2b;
            border-radius: 15px;
            padding: 20px 25px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .buy-popup-title {
            color: #ffd700;
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .buy-popup-title .icon {
            font-size: 24px;
        }

        .buy-popup-price {
            color: #d4a574;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .qty-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #8b5a2b;
            background: linear-gradient(180deg, #5d4037 0%, #3d2317 100%);
            color: #ffd700;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .qty-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(139, 90, 43, 0.5);
        }

        .qty-btn:active {
            transform: scale(0.95);
        }

        .qty-display {
            color: white;
            font-size: 24px;
            font-weight: 800;
            min-width: 50px;
        }

        .buy-popup-total {
            color: #ffd700;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .buy-popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .buy-popup-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid;
            font-family: 'Nunito', sans-serif;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .buy-popup-btn:hover {
            transform: translateY(-2px);
        }

        .buy-popup-btn.confirm {
            background: linear-gradient(180deg, #4CAF50 0%, #388E3C 100%);
            border-color: #2E7D32;
            color: white;
        }

        .buy-popup-btn.cancel {
            background: linear-gradient(180deg, #666 0%, #444 100%);
            border-color: #333;
            color: #ccc;
        }

        .buy-popup-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .ingredient.seaweed {
            background: linear-gradient(180deg, #2d5a2d 0%, #1a3a1a 100%);
            color: #a8d8a8;
            box-shadow: 0 8px 25px rgba(26, 58, 26, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.rice {
            background: linear-gradient(180deg, #fff 0%, #e8e0d0 100%);
            color: #8b7355;
            box-shadow: 0 8px 25px rgba(139, 115, 85, 0.5), inset 0 -4px 12px rgba(0,0,0,0.15);
        }

        .ingredient.avocado {
            background: linear-gradient(180deg, #7ab317 0%, #4a7c23 100%);
            color: #e8f5d0;
            box-shadow: 0 8px 25px rgba(74, 124, 35, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.cucumber {
            background: linear-gradient(180deg, #8bc34a 0%, #5d8a3e 100%);
            color: #f0fff0;
            box-shadow: 0 8px 25px rgba(93, 138, 62, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.mango {
            background: linear-gradient(180deg, #ffcc4d 0%, #e89b2d 100%);
            color: #5d3a1a;
            box-shadow: 0 8px 25px rgba(232, 155, 45, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.creamcheese {
            background: linear-gradient(180deg, #fffef8 0%, #f0ead8 100%);
            color: #6b5a44;
            box-shadow: 0 8px 25px rgba(240, 234, 216, 0.6), inset 0 -4px 12px rgba(0,0,0,0.1);
        }

        .ingredient.pumpkin {
            background: linear-gradient(180deg, #ff8c42 0%, #e86400 100%);
            color: #fff5e6;
            box-shadow: 0 8px 25px rgba(232, 100, 0, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.mushroom {
            background: linear-gradient(180deg, #a08070 0%, #6b5344 100%);
            color: #f5efe8;
            box-shadow: 0 8px 25px rgba(107, 83, 68, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.jalapeno {
            background: linear-gradient(180deg, #32cd32 0%, #1a6b1a 100%);
            color: #e8ffe8;
            box-shadow: 0 8px 25px rgba(26, 107, 26, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.pepper {
            background: linear-gradient(180deg, #ff6666 0%, #cc3333 100%);
            color: #fff0f0;
            box-shadow: 0 8px 25px rgba(204, 51, 51, 0.6), inset 0 -4px 12px rgba(0,0,0,0.3);
        }

        .ingredient.ultimate {
            background: linear-gradient(180deg, #ffd700 0%, #daa520 100%);
            color: #4a3800;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6), inset 0 -4px 12px rgba(0,0,0,0.2);
        }

        /* Action buttons */
        .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 1;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 700;
            font-family: 'Nunito', sans-serif;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-4px) scale(1.02);
        }

        .btn:active {
            transform: translateY(-2px) scale(1.01);
        }

        .btn-roll {
            background: linear-gradient(180deg, #ff6b6b 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.5);
        }

        .btn-reset {
            background: linear-gradient(180deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(9, 132, 227, 0.5);
        }

        /* Status messages */
        .status {
            margin-top: 15px;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            display: none;
            text-align: center;
            position: relative;
            z-index: 1;
            font-size: 14px;
        }

        .status.success {
            background: linear-gradient(180deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
            display: block;
        }

        .status.fail {
            background: linear-gradient(180deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #dc3545;
            box-shadow: 0 5px 20px rgba(220, 53, 69, 0.4);
            display: block;
        }

        /* Order ticket */
        .current-order {
            background: linear-gradient(180deg, #fffef5, #f5f0e0);
            border: 2px solid #d4c4a8;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 11px;
            color: #5d4037;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            position: relative;
            z-index: 1;
        }

        .order-label {
            font-weight: 700;
            color: #8b7355;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .order-items {
            margin-top: 4px;
            font-weight: 600;
        }

        /* Empty mat message */
        .empty-mat {
            color: #2d4a2d;
            font-size: 12px;
            font-style: italic;
            background: rgba(255,255,255,0.75);
            padding: 8px 18px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            align-self: center;
            margin: 20px 0;
        }

        /* Stack container for proper bottom-up stacking */
        .flat-roll:not(:empty) {
            padding: 10px 0;
        }

        /* Chef instruction board on wall */
        .wall-board {
            max-width: 450px;
            margin: 0 auto 20px;
            background: linear-gradient(180deg, #1f1410 0%, #2c1a12 50%, #1f1410 100%);
            padding: 12px 22px;
            border-radius: 5px;
            border: 5px solid #5d4037;
            box-shadow:
                0 10px 40px rgba(0,0,0,0.6),
                inset 0 0 30px rgba(0,0,0,0.3);
            position: relative;
            transform: translateZ(20px);
        }

        .wall-board::before {
            content: '';
            position: absolute;
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
            width: 25px;
            height: 18px;
            background: linear-gradient(180deg, #5d4037, #8b5a2b);
            border-radius: 3px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }

        .board-title {
            color: #ffd700;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 6px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .board-text {
            color: #e8d8c8;
            font-size: 12px;
            line-height: 1.5;
        }

        .board-text strong {
            color: #ffd700;
        }

        /* Floor reflection/shadow at bottom */
        .floor-shadow {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- Order Boxes Row - Fixed at top -->
    <div id="orderRow" style="display: flex; justify-content: center; align-items: center; gap: 15px; padding: 15px; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; min-height: 100px; background: linear-gradient(180deg, rgba(30,20,15,0.95), rgba(20,10,5,0.9)); border-bottom: 3px solid #8b5a2b; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
        <!-- Order boxes added by JS -->
    </div>

    <div class="scene" style="margin-top: 110px;">
        <div class="restaurant">
            <div class="ceiling"></div>

            <!-- Hanging lanterns -->
            <div class="lanterns">
                <div class="lantern"></div>
                <div class="lantern"></div>
                <div class="lantern"></div>
                <div class="lantern"></div>
            </div>

            <!-- Restaurant sign -->
            <div class="restaurant-sign">
                <div class="sign-board">
                    <div class="restaurant-name">OISHII SUSHI</div>
                    <div class="restaurant-subtitle">~ Handcrafted Rolls ~</div>
                </div>
            </div>

            <div class="counter-area">
                <!-- Wall menu board -->
                <div class="wall-board">
                    <div class="board-title">Chef's Instructions</div>
                    <div class="board-text">
                        1. Click <strong>Rice</strong> to cook (3s), click <strong>Fillings</strong> to chop (1.5s)<br>
                        2. Click <strong>Seaweed</strong>, then prepared rice &amp; fillings to layer<br>
                        3. Press <strong>Roll</strong> and drag to matching order!
                    </div>
                </div>

                <!-- Counter with perspective -->
                <div class="counter-surface">
                    <!-- Left side - Base ingredients -->
                    <div class="ingredient-side left-side">
                        <div class="side-label">Base Ingredients</div>
                        <div id="leftIngredients">
                            <!-- Seaweed and Rice buttons -->
                        </div>
                    </div>

                    <!-- Center - Main workspace -->
                    <div class="sushi-counter">
                        <div class="counter-label">Prep Station</div>

                        <!-- Prep stations - dynamically rendered -->
                        <div class="prep-stations-container" id="prepStationsContainer"></div>

                        <div class="counter-label">Sushi Assembly</div>

                        <!-- Bamboo mat -->
                        <div class="bamboo-mat">
                            <div class="flat-roll" id="flatRoll">
                                <div class="empty-mat" id="emptyMessage">Add prepared ingredients...</div>
                            </div>
                            <div class="rolled-sushi" id="rolledSushi">
                                <div class="sushi-plate">
                                    <div class="sushi-roll-container">
                                        <div class="sushi-roll"></div>
                                        <div class="sushi-end">
                                            <div class="sushi-rice-ring">
                                                <div class="sushi-fillings" id="sushiFillings">
                                                    <!-- Fillings added by JS -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="plate-garnish">
                                        <div class="wasabi"></div>
                                        <div class="ginger">
                                            <div class="ginger-slice"></div>
                                            <div class="ginger-slice"></div>
                                            <div class="ginger-slice"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action buttons -->
                        <div class="actions">
                            <button class="btn btn-roll" onclick="rollSushi()">
                                <span></span> Roll It!
                            </button>
                            <button class="btn btn-reset" onclick="resetGame()">
                                <span></span> New Order
                            </button>
                        </div>

                        <!-- Current order display -->
                        <div class="current-order">
                            <div class="order-label">Your Order</div>
                            <div class="order-items" id="orderItems">Nothing yet...</div>
                        </div>

                        <!-- Status message -->
                        <div class="status" id="status"></div>
                    </div>

                    <!-- Right side - Fillings -->
                    <div class="ingredient-side right-side">
                        <div class="side-label">Fresh Fillings</div>
                        <div id="rightIngredients">
                            <!-- Avocado, Cucumber, Mango buttons -->
                        </div>
                    </div>

                    <!-- Bento Storage Box -->
                    <div class="storage-area">
                        <div class="bento-box">
                            <div class="bento-label">Bento Box</div>
                            <div class="bento-interior" id="bentoInterior">
                                <div class="bento-empty" id="bentoEmpty">Drag sushi here!</div>
                            </div>
                            <div class="bento-count" id="bentoCount">0 rolls stored</div>
                        </div>
                        <!-- Coin Display -->
                        <div class="coin-display">
                            <span class="coin-icon"></span>
                            <span id="coinCount">0</span>
                        </div>
                        <!-- Level Display -->
                        <div class="level-display">
                            <div class="level-label">Level</div>
                            <div class="level-number" id="levelNumber">1</div>
                            <div class="level-progress">
                                <div class="level-progress-bar" id="levelProgressBar" style="width: 0%"></div>
                            </div>
                            <div class="level-progress-text" id="levelProgressText">0/10 orders</div>
                        </div>
                        <!-- Shop Button -->
                        <button class="shop-btn" onclick="openShop()"> Shop</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="floor-shadow"></div>

    <script>
        let layers = [];
        const fillings = ['avocado', 'cucumber', 'mango', 'creamcheese', 'pumpkin', 'mushroom', 'jalapeno', 'pepper', 'ultimate'];
        let currentSushiFillings = [];
        let bentoCount = 0;
        let coins = 0;
        let currentOrder = [];
        let speechBubble = null;

        // Level system
        let level = 1;
        let ordersFilledTotal = 0;
        let ordersFilledThisLevel = 0;
        const ORDERS_PER_LEVEL = 10;

        // Equipment counts
        let numChoppingBoards = 2;
        let numRiceCookers = 1;
        const CHOPPING_BOARD_PRICE = 20;
        const RICE_COOKER_PRICE = 30;

        // Auto equipment
        let hasAutoCooker = false;
        let hasAutoChopper = false;
        let hasAutoAssembler = false;
        const AUTO_COOKER_PRICE = 40;
        const AUTO_CHOPPER_PRICE = 45;
        const AUTO_ASSEMBLER_PRICE = 90;

        // Bot upgrade levels (0 = base speed, higher = faster)
        let autoCookerLevel = 0;
        let autoChopperLevel = 0;
        let autoAssemblerLevel = 0;
        const BOT_UPGRADE_PRICE = 50;

        // Price increase upgrade
        let priceIncreaseLevel = 0;
        const PRICE_INCREASE_PRICE = 30;

        // Ingredient inventory - start with 10 of each
        const inventory = {
            seaweed: 10,
            rice: 10,
            avocado: 10,
            cucumber: 10,
            mango: 10,
            creamcheese: 0,
            pumpkin: 0,
            mushroom: 0,
            jalapeno: 0,
            pepper: 0,
            ultimate: 0
        };

        // Ingredient info (icon, price per unit)
        // Prices are 1 less than sell price for profit margin
        const ingredientInfo = {
            seaweed: { icon: '', price: 2 },
            rice: { icon: '', price: 2 },
            avocado: { icon: '', price: 4, sellPrice: 5 },
            cucumber: { icon: '', price: 4, sellPrice: 5 },
            mango: { icon: '', price: 4, sellPrice: 5 },
            creamcheese: { icon: '', price: 7, sellPrice: 8, unlockLevel: 2 },
            pumpkin: { icon: '', price: 7, sellPrice: 8, unlockLevel: 2 },
            mushroom: { icon: '', price: 8, sellPrice: 9, unlockLevel: 3 },
            jalapeno: { icon: '', price: 9, sellPrice: 10, unlockLevel: 4 },
            pepper: { icon: '', price: 9, sellPrice: 10, unlockLevel: 4 },
            ultimate: { icon: '', price: 100, sellPrice: 101, unlockLevel: 5 }
        };

        // Filling colors for pie chart
        const fillingColors = {
            avocado: '#7ab317',
            cucumber: '#8bc34a',
            mango: '#f5a623',
            creamcheese: '#f8f4e8',
            pumpkin: '#ff7518',
            mushroom: '#8b7355',
            jalapeno: '#228b22',
            pepper: '#ff4444',
            ultimate: '#ffd700'
        };

        // Hair colors for variety
        const hairColors = ['#2a1a0a', '#5c3317', '#8b4513', '#d4a574', '#1a1a1a', '#c41e3a'];
        const skinTones = [
            { base: '#ffdbac', shadow: '#f0c08a' },
            { base: '#f1c27d', shadow: '#e0a860' },
            { base: '#c68642', shadow: '#a56b2a' },
            { base: '#8d5524', shadow: '#6b3e1a' },
            { base: '#ffe0bd', shadow: '#f0cba8' }
        ];

        // Generate pie chart gradient
        function generatePieGradient(fillingsList) {
            if (fillingsList.length === 0) return '#e8e0d5';
            const sliceAngle = 360 / fillingsList.length;
            let gradientStops = [];
            let currentAngle = 0;
            fillingsList.forEach(filling => {
                const color = fillingColors[filling];
                const nextAngle = currentAngle + sliceAngle;
                gradientStops.push(`${color} ${currentAngle}deg ${nextAngle}deg`);
                currentAngle = nextAngle;
            });
            return `conic-gradient(${gradientStops.join(', ')})`;
        }

        // Setup drag and drop for bento box
        const bentoInterior = document.getElementById('bentoInterior');

        bentoInterior.addEventListener('dragover', (e) => {
            e.preventDefault();
            bentoInterior.classList.add('drag-over');
        });

        bentoInterior.addEventListener('dragleave', () => {
            bentoInterior.classList.remove('drag-over');
        });

        bentoInterior.addEventListener('drop', (e) => {
            e.preventDefault();
            bentoInterior.classList.remove('drag-over');

            // Only accept drops from the workspace sushi
            if (dragSource === 'workspace') {
                // Add mini sushi to bento
                addSushiToBento(currentSushiFillings);
                // Reset the game for new sushi
                resetGame();
            }
            dragSource = null;
        });

        // Track drag source
        let dragSource = null;
        let draggedBentoSushi = null;
        let draggedBentoFillings = [];

        // Setup bamboo mat as drop zone for returning sushi
        const bambooMat = document.querySelector('.bamboo-mat');

        bambooMat.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (dragSource === 'bento') {
                bambooMat.classList.add('drag-over');
            }
        });

        bambooMat.addEventListener('dragleave', () => {
            bambooMat.classList.remove('drag-over');
        });

        bambooMat.addEventListener('drop', (e) => {
            e.preventDefault();
            bambooMat.classList.remove('drag-over');

            // Only accept drops from bento
            if (dragSource === 'bento' && draggedBentoSushi) {
                // Display sushi on the plate
                displaySushiOnPlate(draggedBentoFillings);

                // Remove from bento
                draggedBentoSushi.remove();
                bentoCount--;
                document.getElementById('bentoCount').textContent = `${bentoCount} roll${bentoCount !== 1 ? 's' : ''} stored`;

                // Show empty message if no sushi left
                if (bentoCount === 0) {
                    document.getElementById('bentoEmpty').style.display = 'block';
                }

                draggedBentoSushi = null;
                draggedBentoFillings = [];
            }
            dragSource = null;
        });

        // Prep station busy tracking
        let choppingBoardBusy = []; // Array tracking busy state for each board
        let riceCookerBusy = []; // Array tracking busy state for each cooker
        let draggedIngredient = null;

        // Initialize busy arrays
        function initBusyArrays() {
            choppingBoardBusy = new Array(numChoppingBoards).fill(false);
            riceCookerBusy = new Array(numRiceCookers).fill(false);
        }

        // Render prep stations dynamically
        function renderPrepStations() {
            const container = document.getElementById('prepStationsContainer');

            // Store current chopped outputs before clearing
            const savedChoppedOutputs = {};
            for (let i = 1; i <= 20; i++) {
                const output = document.getElementById(`choppedOutput${i}`);
                if (output) savedChoppedOutputs[i] = output.innerHTML;
            }

            // Store current cooked rice outputs
            const savedRiceOutputs = {};
            for (let i = 1; i <= 20; i++) {
                const output = document.getElementById(`cookedRiceOutput${i}`);
                if (output) savedRiceOutputs[i] = output.innerHTML;
            }

            container.innerHTML = '';

            // Expand busy arrays if needed
            while (choppingBoardBusy.length < numChoppingBoards) {
                choppingBoardBusy.push(false);
            }
            while (riceCookerBusy.length < numRiceCookers) {
                riceCookerBusy.push(false);
            }

            // Arrange in row: half chopping boards, rice cookers, half chopping boards
            const halfBoards = Math.floor(numChoppingBoards / 2);
            const remainingBoards = numChoppingBoards - halfBoards;

            // First half of chopping boards
            for (let i = 1; i <= halfBoards; i++) {
                container.appendChild(createChoppingBoard(i, savedChoppedOutputs[i]));
            }

            // All rice cookers in the middle
            for (let i = 1; i <= numRiceCookers; i++) {
                container.appendChild(createRiceCooker(i, savedRiceOutputs[i]));
            }

            // Second half of chopping boards
            for (let i = halfBoards + 1; i <= numChoppingBoards; i++) {
                container.appendChild(createChoppingBoard(i, savedChoppedOutputs[i]));
            }

            // Update prepared display to restore rice chip handlers
            updatePreparedDisplay();
        }

        function createChoppingBoard(i, savedOutput) {
            const board = document.createElement('div');
            board.className = 'prep-station chopping-board';
            board.id = `choppingBoard${i}`;
            board.innerHTML = `
                <div class="board-surface" id="boardSurface${i}">
                    <div class="board-empty">Drop fillings</div>
                </div>
                <div class="knife"></div>
                <div class="prep-label">Chopping Board</div>
                <div class="chopped-output" id="choppedOutput${i}"></div>
            `;

            // Restore saved output after appending
            setTimeout(() => {
                if (savedOutput) {
                    document.getElementById(`choppedOutput${i}`).innerHTML = savedOutput;
                    // Re-attach click handlers to chopped items
                    const chips = document.querySelectorAll(`#choppedOutput${i} .prepared-item`);
                    chips.forEach(chip => {
                        const ingredient = chip.className.split(' ').find(c =>
                            ['avocado', 'cucumber', 'mango', 'pumpkin', 'mushroom', 'jalapeno', 'pepper', 'ultimate'].includes(c)
                        );
                        if (ingredient) {
                            chip.onclick = () => {
                                addIngredient(ingredient, true);
                                chip.remove();
                            };
                        }
                    });
                }
            }, 0);

            return board;
        }

        function createRiceCooker(i, savedOutput) {
            const cooker = document.createElement('div');
            cooker.className = 'prep-station rice-cooker';
            cooker.id = `riceCooker${i}`;
            cooker.innerHTML = `
                <div class="cooker-body" id="cookerBody${i}">
                    <div class="cooker-lid"></div>
                    <div class="cooker-bowl" id="cookerBowl${i}">
                        <div class="cooker-empty">Click rice</div>
                    </div>
                    <div class="cooker-base"></div>
                </div>
                <div class="prep-label">Rice Cooker</div>
                <div class="cooked-rice-output" id="cookedRiceOutput${i}"></div>
            `;

            // Restore saved output after appending
            setTimeout(() => {
                if (savedOutput) {
                    document.getElementById(`cookedRiceOutput${i}`).innerHTML = savedOutput;
                }
            }, 0);

            return cooker;
        }

        // Create all ingredient buttons - split left/right
        function createIngredientButtons() {
            const leftContainer = document.getElementById('leftIngredients');
            const rightContainer = document.getElementById('rightIngredients');
            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';

            const baseIngredients = ['seaweed', 'rice'];
            let fillingIngredients = ['avocado', 'cucumber', 'mango'];

            // Add level 2+ ingredients
            if (level >= 2) {
                fillingIngredients.push('creamcheese', 'pumpkin');
            }
            if (level >= 3) {
                fillingIngredients.push('mushroom');
            }
            if (level >= 4) {
                fillingIngredients.push('jalapeno', 'pepper');
            }
            if (level >= 5) {
                fillingIngredients.push('ultimate');
            }

            // Create base ingredients (left side)
            baseIngredients.forEach(ingredient => {
                createIngredientButton(ingredient, leftContainer);
            });

            // Split fillings between left and right for balance
            const halfIndex = Math.ceil(fillingIngredients.length / 2);
            const leftFillings = fillingIngredients.slice(0, halfIndex);
            const rightFillings = fillingIngredients.slice(halfIndex);

            // Create left filling ingredients
            leftFillings.forEach(ingredient => {
                createIngredientButton(ingredient, leftContainer);
            });

            // Create right filling ingredients
            rightFillings.forEach(ingredient => {
                createIngredientButton(ingredient, rightContainer);
            });

            // Update prepared items display
            updatePreparedDisplay();
        }

        function createIngredientButton(ingredient, container) {
            const btn = document.createElement('button');
            btn.className = `ingredient ${ingredient}`;
            btn.id = `btn-${ingredient}`;

            const info = ingredientInfo[ingredient];
            const count = inventory[ingredient];

            if (count > 0) {
                btn.innerHTML = `
                    <span class="count">${count}</span>
                    <span class="icon">${info.icon}</span>
                    ${ingredient.charAt(0).toUpperCase() + ingredient.slice(1)}
                `;

                // Seaweed and cream cheese can be clicked directly (no prep needed)
                if (ingredient === 'seaweed' || ingredient === 'creamcheese') {
                    btn.onclick = () => addIngredient(ingredient);
                }
                // Rice clicks to start cooking
                else if (ingredient === 'rice') {
                    btn.onclick = () => {
                        if (inventory.rice > 0) {
                            // Find available rice cooker
                            const availableCooker = riceCookerBusy.findIndex(busy => !busy);
                            if (availableCooker !== -1) {
                                inventory.rice--;
                                createIngredientButtons();
                                startCookingRice(availableCooker + 1);
                            } else {
                                showStatus('All rice cookers are busy!', 'fail');
                            }
                        }
                    };
                }
                // Fillings click to chop on available board
                else {
                    btn.onclick = () => {
                        if (inventory[ingredient] > 0) {
                            // Find available chopping board
                            const availableBoard = choppingBoardBusy.findIndex(busy => !busy);
                            if (availableBoard !== -1) {
                                inventory[ingredient]--;
                                createIngredientButtons();
                                startChopping(ingredient, availableBoard + 1);
                            } else {
                                showStatus('All chopping boards are busy!', 'fail');
                            }
                        }
                    };
                }
            } else {
                btn.innerHTML = `
                    <span class="icon">${info.icon}</span>
                    <span class="buy-label">BUY</span>
                    <span class="buy-price"> ${info.price}/ea</span>
                `;
                btn.onclick = () => showBuyPopup(ingredient);
                btn.classList.add('out-of-stock');
            }

            container.appendChild(btn);
        }

        // No setup needed - fillings are clicked now
        function setupPrepStations() {
            // Nothing to setup - click handlers are on ingredient buttons
        }

        // Cook rice (2 seconds)
        function startCookingRice(cookerNum) {
            // Mark cooker as busy (cookerNum is 1-indexed)
            riceCookerBusy[cookerNum - 1] = true;

            const cookerBowl = document.getElementById(`cookerBowl${cookerNum}`);
            cookerBowl.classList.add('cooking');
            cookerBowl.innerHTML = `<div class="cooking-timer" id="cookingTimer${cookerNum}">2</div>`;

            let timeLeft = 2;
            const timer = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById(`cookingTimer${cookerNum}`);
                if (timerEl) timerEl.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timer);
                    // Mark cooker as free
                    riceCookerBusy[cookerNum - 1] = false;
                    cookerBowl.classList.remove('cooking');
                    cookerBowl.innerHTML = '<div class="cooker-empty">Click rice</div>';

                    // Add cooked rice to this cooker's output
                    addCookedRiceToCooker(cookerNum);
                    showStatus('Rice is ready!', 'success');
                }
            }, 1000);
        }

        // Add cooked rice to specific cooker's output
        function addCookedRiceToCooker(cookerNum) {
            const output = document.getElementById(`cookedRiceOutput${cookerNum}`);

            const chip = document.createElement('div');
            chip.className = 'prepared-item cooked-rice';
            chip.textContent = ' Rice';
            chip.onclick = () => {
                addIngredient('rice', true);
                chip.remove();
            };
            output.appendChild(chip);
        }

        // Start chopping (1 second)
        function startChopping(ingredient, boardNum) {
            // Mark board as busy (boardNum is 1-indexed)
            choppingBoardBusy[boardNum - 1] = true;

            const board = document.getElementById(`choppingBoard${boardNum}`);
            const boardSurface = document.getElementById(`boardSurface${boardNum}`);
            const knife = board.querySelector('.knife');

            // Show ingredient on board
            boardSurface.innerHTML = `<div class="chopping-item ${ingredient}">${ingredientInfo[ingredient].icon}</div>`;
            boardSurface.classList.add('chopping');

            // Animate knife chopping
            knife.style.animation = 'chopAnimation 0.3s ease-out infinite';

            // After 1 second, finish chopping
            setTimeout(() => {
                // Stop animation
                knife.style.animation = '';

                // Clear board
                boardSurface.classList.remove('chopping');
                boardSurface.innerHTML = '<div class="board-empty">Drop fillings</div>';

                // Mark board as free (boardNum is 1-indexed)
                choppingBoardBusy[boardNum - 1] = false;

                // Add chopped filling to that board's output
                addChoppedToBoard(ingredient, boardNum);
                showStatus(`${ingredient.charAt(0).toUpperCase() + ingredient.slice(1)} chopped!`, 'success');
            }, 1000);
        }

        // Add chopped filling to specific board's output
        function addChoppedToBoard(ingredient, boardNum) {
            const output = document.getElementById(`choppedOutput${boardNum}`);

            const chip = document.createElement('div');
            chip.className = `prepared-item chopped ${ingredient}`;
            chip.textContent = `${ingredientInfo[ingredient].icon} ${ingredient.charAt(0).toUpperCase() + ingredient.slice(1)}`;
            chip.onclick = () => {
                addIngredient(ingredient, true);
                chip.remove();
            };
            output.appendChild(chip);
        }

        // Update prepared ingredients display (only rice - chopped fillings managed separately)
        function updatePreparedDisplay() {
            // Rice chips are now added directly to each cooker's output
            // This function is kept for compatibility with renderPrepStations
        }

        // Show buy popup with quantity selector
        let currentBuyPopup = null;

        function showBuyPopup(ingredient) {
            // Remove any existing popup
            if (currentBuyPopup) {
                currentBuyPopup.remove();
            }

            const info = ingredientInfo[ingredient];
            let quantity = 1;
            const maxAffordable = Math.floor(coins / info.price);

            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'buy-popup-overlay';
            currentBuyPopup = overlay;

            // Create popup
            const popup = document.createElement('div');
            popup.className = 'buy-popup';

            const updatePopup = () => {
                const total = quantity * info.price;
                const canAfford = coins >= total;

                popup.innerHTML = `
                    <div class="buy-popup-title">
                        <span class="icon">${info.icon}</span>
                        Buy ${ingredient.charAt(0).toUpperCase() + ingredient.slice(1)}
                    </div>
                    <div class="buy-popup-price">${info.price} coins each</div>
                    <div class="quantity-selector">
                        <button class="qty-btn" id="qty-minus">-</button>
                        <span class="qty-display">${quantity}</span>
                        <button class="qty-btn" id="qty-plus">+</button>
                    </div>
                    <div class="buy-popup-total">
                        Total:  ${total} ${!canAfford ? '(not enough!)' : ''}
                    </div>
                    <div class="buy-popup-buttons">
                        <button class="buy-popup-btn cancel" id="buy-cancel">Cancel</button>
                        <button class="buy-popup-btn confirm" id="buy-confirm" ${!canAfford ? 'disabled' : ''}>Buy</button>
                    </div>
                `;

                // Add event listeners
                popup.querySelector('#qty-minus').onclick = () => {
                    if (quantity > 1) {
                        quantity--;
                        updatePopup();
                    }
                };

                popup.querySelector('#qty-plus').onclick = () => {
                    if (quantity < 99) {
                        quantity++;
                        updatePopup();
                    }
                };

                popup.querySelector('#buy-cancel').onclick = () => {
                    overlay.remove();
                    currentBuyPopup = null;
                };

                popup.querySelector('#buy-confirm').onclick = () => {
                    if (canAfford) {
                        completePurchase(ingredient, quantity);
                        overlay.remove();
                        currentBuyPopup = null;
                    }
                };
            };

            updatePopup();
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    currentBuyPopup = null;
                }
            };
        }

        // Complete the purchase
        function completePurchase(ingredient, quantity) {
            const info = ingredientInfo[ingredient];
            const total = quantity * info.price;

            if (coins >= total) {
                coins -= total;
                inventory[ingredient] += quantity;
                document.getElementById('coinCount').textContent = coins;
                createIngredientButtons();
                showStatus(`Bought ${quantity}x ${ingredient}!`, 'success');
            }
        }

        // Shop popup for equipment
        let currentShopPopup = null;

        function openShop() {
            if (currentShopPopup) {
                currentShopPopup.remove();
            }

            const overlay = document.createElement('div');
            overlay.className = 'shop-popup-overlay';
            currentShopPopup = overlay;

            const popup = document.createElement('div');
            popup.className = 'shop-popup';

            const updateShopContent = () => {
                const canAffordBoard = coins >= CHOPPING_BOARD_PRICE;
                const canAffordCooker = coins >= RICE_COOKER_PRICE;
                const canAffordAutoCooker = coins >= AUTO_COOKER_PRICE && !hasAutoCooker;
                const canAffordAutoChopper = coins >= AUTO_CHOPPER_PRICE && !hasAutoChopper;
                const canAffordAutoAssembler = coins >= AUTO_ASSEMBLER_PRICE && !hasAutoAssembler;
                const canAffordPriceIncrease = coins >= PRICE_INCREASE_PRICE;
                const canAffordCookerUpgrade = coins >= BOT_UPGRADE_PRICE && hasAutoCooker;
                const canAffordChopperUpgrade = coins >= BOT_UPGRADE_PRICE && hasAutoChopper;
                const canAffordAssemblerUpgrade = coins >= BOT_UPGRADE_PRICE && hasAutoAssembler;

                popup.innerHTML = `
                    <div class="shop-title"> Equipment Shop</div>
                    <div class="shop-section">Basic Equipment</div>
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <span class="shop-item-icon"></span>
                            <div class="shop-item-details">
                                <span class="shop-item-name">Chopping Board</span>
                                <span class="shop-item-owned">Owned: ${numChoppingBoards}</span>
                            </div>
                        </div>
                        <div class="shop-item-price"> ${CHOPPING_BOARD_PRICE}</div>
                        <button class="shop-buy-btn" id="buyBoardBtn" ${!canAffordBoard ? 'disabled' : ''}>Buy</button>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <span class="shop-item-icon"></span>
                            <div class="shop-item-details">
                                <span class="shop-item-name">Rice Cooker</span>
                                <span class="shop-item-owned">Owned: ${numRiceCookers}</span>
                            </div>
                        </div>
                        <div class="shop-item-price"> ${RICE_COOKER_PRICE}</div>
                        <button class="shop-buy-btn" id="buyCookerBtn" ${!canAffordCooker ? 'disabled' : ''}>Buy</button>
                    </div>
                    <div class="shop-section">Automation</div>
                    <div class="shop-item ${hasAutoCooker ? 'owned' : ''}">
                        <div class="shop-item-info">
                            <span class="shop-item-icon"></span>
                            <div class="shop-item-details">
                                <span class="shop-item-name">Auto Cooker</span>
                                <span class="shop-item-owned">${hasAutoCooker ? ' Owned (Lvl ' + (autoCookerLevel + 1) + ')' : 'Auto-cooks rice'}</span>
                            </div>
                        </div>
                        <div class="shop-item-price"> ${AUTO_COOKER_PRICE}</div>
                        <button class="shop-buy-btn" id="buyAutoCookerBtn" ${!canAffordAutoCooker ? 'disabled' : ''}>${hasAutoCooker ? 'Owned' : 'Buy'}</button>
                        ${hasAutoCooker ? `<button class="shop-buy-btn upgrade-btn" id="upgradeAutoCookerBtn" ${!canAffordCookerUpgrade ? 'disabled' : ''}>${BOT_UPGRADE_PRICE} Upgrade</button>` : ''}
                    </div>
                    <div class="shop-item ${hasAutoChopper ? 'owned' : ''}">
                        <div class="shop-item-info">
                            <span class="shop-item-icon"></span>
                            <div class="shop-item-details">
                                <span class="shop-item-name">Auto Chopper</span>
                                <span class="shop-item-owned">${hasAutoChopper ? ' Owned (Lvl ' + (autoChopperLevel + 1) + ')' : 'Auto-chops fillings'}</span>
                            </div>
                        </div>
                        <div class="shop-item-price"> ${AUTO_CHOPPER_PRICE}</div>
                        <button class="shop-buy-btn" id="buyAutoChopperBtn" ${!canAffordAutoChopper ? 'disabled' : ''}>${hasAutoChopper ? 'Owned' : 'Buy'}</button>
                        ${hasAutoChopper ? `<button class="shop-buy-btn upgrade-btn" id="upgradeAutoChopperBtn" ${!canAffordChopperUpgrade ? 'disabled' : ''}>${BOT_UPGRADE_PRICE} Upgrade</button>` : ''}
                    </div>
                    <div class="shop-item ${hasAutoAssembler ? 'owned' : ''}">
                        <div class="shop-item-info">
                            <span class="shop-item-icon"></span>
                            <div class="shop-item-details">
                                <span class="shop-item-name">Auto Assembler</span>
                                <span class="shop-item-owned">${hasAutoAssembler ? ' Owned (Lvl ' + (autoAssemblerLevel + 1) + ')' : 'Auto-assembles sushi'}</span>
                            </div>
                        </div>
                        <div class="shop-item-price"> ${AUTO_ASSEMBLER_PRICE}</div>
                        <button class="shop-buy-btn" id="buyAutoAssemblerBtn" ${!canAffordAutoAssembler ? 'disabled' : ''}>${hasAutoAssembler ? 'Owned' : 'Buy'}</button>
                        ${hasAutoAssembler ? `<button class="shop-buy-btn upgrade-btn" id="upgradeAutoAssemblerBtn" ${!canAffordAssemblerUpgrade ? 'disabled' : ''}>${BOT_UPGRADE_PRICE} Upgrade</button>` : ''}
                    </div>
                    <div class="shop-section">Upgrades</div>
                    <div class="shop-item">
                        <div class="shop-item-info">
                            <span class="shop-item-icon"></span>
                            <div class="shop-item-details">
                                <span class="shop-item-name">Price Increase</span>
                                <span class="shop-item-owned">Level: ${priceIncreaseLevel} (+${priceIncreaseLevel} coins/sale)</span>
                            </div>
                        </div>
                        <div class="shop-item-price"> ${PRICE_INCREASE_PRICE}</div>
                        <button class="shop-buy-btn" id="buyPriceIncreaseBtn" ${!canAffordPriceIncrease ? 'disabled' : ''}>Buy</button>
                    </div>
                    <button class="shop-close-btn" id="closeShopBtn">Close</button>
                `;

                popup.querySelector('#buyBoardBtn').onclick = () => {
                    if (coins >= CHOPPING_BOARD_PRICE) {
                        coins -= CHOPPING_BOARD_PRICE;
                        numChoppingBoards++;
                        document.getElementById('coinCount').textContent = coins;
                        renderPrepStations();
                        showStatus('Bought a chopping board!', 'success');
                        updateShopContent();
                    }
                };

                popup.querySelector('#buyCookerBtn').onclick = () => {
                    if (coins >= RICE_COOKER_PRICE) {
                        coins -= RICE_COOKER_PRICE;
                        numRiceCookers++;
                        document.getElementById('coinCount').textContent = coins;
                        renderPrepStations();
                        showStatus('Bought a rice cooker!', 'success');
                        updateShopContent();
                    }
                };

                popup.querySelector('#buyAutoCookerBtn').onclick = () => {
                    if (coins >= AUTO_COOKER_PRICE && !hasAutoCooker) {
                        coins -= AUTO_COOKER_PRICE;
                        hasAutoCooker = true;
                        document.getElementById('coinCount').textContent = coins;
                        showStatus('Bought Auto Cooker!', 'success');
                        updateShopContent();
                    }
                };

                popup.querySelector('#buyAutoChopperBtn').onclick = () => {
                    if (coins >= AUTO_CHOPPER_PRICE && !hasAutoChopper) {
                        coins -= AUTO_CHOPPER_PRICE;
                        hasAutoChopper = true;
                        document.getElementById('coinCount').textContent = coins;
                        showStatus('Bought Auto Chopper!', 'success');
                        updateShopContent();
                    }
                };

                popup.querySelector('#buyAutoAssemblerBtn').onclick = () => {
                    if (coins >= AUTO_ASSEMBLER_PRICE && !hasAutoAssembler) {
                        coins -= AUTO_ASSEMBLER_PRICE;
                        hasAutoAssembler = true;
                        document.getElementById('coinCount').textContent = coins;
                        showStatus('Bought Auto Assembler!', 'success');
                        updateShopContent();
                    }
                };

                popup.querySelector('#buyPriceIncreaseBtn').onclick = () => {
                    if (coins >= PRICE_INCREASE_PRICE) {
                        coins -= PRICE_INCREASE_PRICE;
                        priceIncreaseLevel++;
                        document.getElementById('coinCount').textContent = coins;
                        showStatus('Prices increased by 1 coin!', 'success');
                        updateShopContent();
                    }
                };

                // Bot upgrade handlers
                const upgradeAutoCookerBtn = popup.querySelector('#upgradeAutoCookerBtn');
                if (upgradeAutoCookerBtn) {
                    upgradeAutoCookerBtn.onclick = () => {
                        if (coins >= BOT_UPGRADE_PRICE && hasAutoCooker) {
                            coins -= BOT_UPGRADE_PRICE;
                            autoCookerLevel++;
                            document.getElementById('coinCount').textContent = coins;
                            showStatus('Auto Cooker upgraded to Lvl ' + (autoCookerLevel + 1) + '!', 'success');
                            updateShopContent();
                        }
                    };
                }

                const upgradeAutoChopperBtn = popup.querySelector('#upgradeAutoChopperBtn');
                if (upgradeAutoChopperBtn) {
                    upgradeAutoChopperBtn.onclick = () => {
                        if (coins >= BOT_UPGRADE_PRICE && hasAutoChopper) {
                            coins -= BOT_UPGRADE_PRICE;
                            autoChopperLevel++;
                            document.getElementById('coinCount').textContent = coins;
                            showStatus('Auto Chopper upgraded to Lvl ' + (autoChopperLevel + 1) + '!', 'success');
                            updateShopContent();
                        }
                    };
                }

                const upgradeAutoAssemblerBtn = popup.querySelector('#upgradeAutoAssemblerBtn');
                if (upgradeAutoAssemblerBtn) {
                    upgradeAutoAssemblerBtn.onclick = () => {
                        if (coins >= BOT_UPGRADE_PRICE && hasAutoAssembler) {
                            coins -= BOT_UPGRADE_PRICE;
                            autoAssemblerLevel++;
                            document.getElementById('coinCount').textContent = coins;
                            showStatus('Auto Assembler upgraded to Lvl ' + (autoAssemblerLevel + 1) + '!', 'success');
                            updateShopContent();
                        }
                    };
                }

                popup.querySelector('#closeShopBtn').onclick = closeShop;
            };

            overlay.appendChild(popup);
            overlay.onclick = (e) => {
                if (e.target === overlay) closeShop();
            };
            document.body.appendChild(overlay);
            updateShopContent();
        }

        function closeShop() {
            if (currentShopPopup) {
                currentShopPopup.remove();
                currentShopPopup = null;
            }
        }

        // Update a single ingredient button
        function updateIngredientButton(ingredient) {
            createIngredientButtons();
        }

        function addIngredient(ingredient, skipInventory = false) {
            if (document.getElementById('rolledSushi').style.display === 'flex') {
                return;
            }

            // Check if we have this ingredient (only if not already prepared)
            if (!skipInventory && inventory[ingredient] <= 0) {
                showStatus(`Out of ${ingredient}! Buy more.`, 'fail');
                return;
            }

            const emptyMsg = document.getElementById('emptyMessage');
            if (emptyMsg) emptyMsg.style.display = 'none';

            // Use up one ingredient (only if not already prepared)
            if (!skipInventory) {
                inventory[ingredient]--;
                updateIngredientButton(ingredient);
            }

            layers.push(ingredient);

            const flatRoll = document.getElementById('flatRoll');
            const layer = document.createElement('div');
            layer.className = `layer ${ingredient}`;
            layer.setAttribute('data-ingredient', ingredient);
            flatRoll.appendChild(layer);

            updateOrderDisplay();
        }

        function updateOrderDisplay() {
            const display = document.getElementById('orderItems');
            if (layers.length === 0) {
                display.textContent = 'Nothing yet...';
            } else {
                display.textContent = layers.map(l => l.charAt(0).toUpperCase() + l.slice(1)).join('  ');
            }
        }

        function rollSushi() {
            if (layers.length === 0) {
                showStatus('Please add some ingredients first!', 'fail');
                return;
            }

            const isValid = validateSushi();

            if (isValid) {
                document.getElementById('flatRoll').style.display = 'none';
                const rolledSushi = document.getElementById('rolledSushi');
                rolledSushi.style.display = 'flex';

                const fillingsContainer = document.getElementById('sushiFillings');
                fillingsContainer.innerHTML = '';

                const addedFillings = layers.filter(l => fillings.includes(l));

                // Create pie chart for fillings
                const pie = document.createElement('div');
                pie.className = 'sushi-fillings-pie';
                pie.style.background = generatePieGradient(addedFillings);
                fillingsContainer.appendChild(pie);

                // Store current fillings for bento
                currentSushiFillings = [...addedFillings];

                // Make sushi draggable
                const rollContainer = document.querySelector('.sushi-roll-container');
                rollContainer.classList.add('draggable');
                rollContainer.setAttribute('draggable', 'true');

                rollContainer.addEventListener('dragstart', (e) => {
                    rollContainer.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    dragSource = 'workspace';
                });

                rollContainer.addEventListener('dragend', () => {
                    rollContainer.classList.remove('dragging');
                });

                showStatus('Oishii! Drag to the customer or bento box!', 'success');
            } else {
                showStatus(getFailureMessage(), 'fail');
            }
        }

        function addSushiToBento(sushiFillings) {
            // Hide empty message
            const emptyMsg = document.getElementById('bentoEmpty');
            if (emptyMsg) emptyMsg.style.display = 'none';

            // Create mini sushi
            const miniSushi = document.createElement('div');
            miniSushi.className = 'bento-sushi';

            // Create the end with fillings
            const end = document.createElement('div');
            end.className = 'bento-sushi-end';

            const riceRing = document.createElement('div');
            riceRing.className = 'bento-rice-ring';

            const fillingsDiv = document.createElement('div');
            fillingsDiv.className = 'bento-fillings';

            const pie = document.createElement('div');
            pie.className = 'bento-fillings-pie';
            pie.style.background = generatePieGradient(sushiFillings);

            fillingsDiv.appendChild(pie);
            riceRing.appendChild(fillingsDiv);
            end.appendChild(riceRing);
            miniSushi.appendChild(end);

            // Store fillings data on the element
            miniSushi.sushiFillings = [...sushiFillings];

            // Make bento sushi draggable
            miniSushi.setAttribute('draggable', 'true');

            miniSushi.addEventListener('dragstart', (e) => {
                miniSushi.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                dragSource = 'bento';
                draggedBentoSushi = miniSushi;
                draggedBentoFillings = miniSushi.sushiFillings;
            });

            miniSushi.addEventListener('dragend', () => {
                miniSushi.classList.remove('dragging');
            });

            bentoInterior.appendChild(miniSushi);

            // Update count
            bentoCount++;
            document.getElementById('bentoCount').textContent = `${bentoCount} roll${bentoCount !== 1 ? 's' : ''} stored`;
        }

        function displaySushiOnPlate(sushiFillings) {
            // Hide the flat roll area
            document.getElementById('flatRoll').style.display = 'none';
            const rolledSushi = document.getElementById('rolledSushi');
            rolledSushi.style.display = 'flex';

            const fillingsContainer = document.getElementById('sushiFillings');
            fillingsContainer.innerHTML = '';

            // Create pie chart for fillings
            const pie = document.createElement('div');
            pie.className = 'sushi-fillings-pie';
            pie.style.background = generatePieGradient(sushiFillings);
            fillingsContainer.appendChild(pie);

            // Store current fillings and reset layers
            currentSushiFillings = [...sushiFillings];
            layers = ['seaweed', 'rice', ...sushiFillings]; // Rebuild layers for proper state

            // Make sushi draggable
            const rollContainer = document.querySelector('.sushi-roll-container');
            rollContainer.classList.add('draggable');
            rollContainer.setAttribute('draggable', 'true');

            // Remove old event listeners by cloning
            const newRollContainer = rollContainer.cloneNode(true);
            rollContainer.parentNode.replaceChild(newRollContainer, rollContainer);

            newRollContainer.addEventListener('dragstart', (e) => {
                newRollContainer.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                dragSource = 'workspace';
            });

            newRollContainer.addEventListener('dragend', () => {
                newRollContainer.classList.remove('dragging');
            });

            // Update order display
            document.getElementById('orderItems').textContent = sushiFillings.length > 0
                ? 'Sushi with ' + sushiFillings.map(l => l.charAt(0).toUpperCase() + l.slice(1)).join(', ')
                : 'Plain sushi roll';

            showStatus('Sushi returned! Drag to bento or make a new order.', 'success');
        }

        function validateSushi() {
            if (layers.length < 2) return false;
            if (layers[0] !== 'seaweed') return false;
            if (layers[1] !== 'rice') return false;

            for (let i = 2; i < layers.length; i++) {
                if (!fillings.includes(layers[i])) return false;
            }

            return true;
        }

        function getFailureMessage() {
            if (layers[0] !== 'seaweed') {
                return 'Oh no! Start with seaweed as your base!';
            }
            if (layers.length < 2 || layers[1] !== 'rice') {
                return 'Oops! Rice should go on top of the seaweed!';
            }
            for (let i = 2; i < layers.length; i++) {
                if (layers[i] === 'seaweed' || layers[i] === 'rice') {
                    return 'Hmm, seaweed and rice only go at the base!';
                }
            }
            return 'Something went wrong! Try again~';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function resetGame() {
            layers = [];
            const flatRoll = document.getElementById('flatRoll');
            flatRoll.innerHTML = '<div class="empty-mat" id="emptyMessage">Add prepared ingredients...</div>';
            flatRoll.style.display = 'flex';
            document.getElementById('rolledSushi').style.display = 'none';
            document.getElementById('sushiFillings').innerHTML = '';
            document.getElementById('status').className = 'status';
            updateOrderDisplay();
        }

        // Update level display
        function updateLevelDisplay() {
            document.getElementById('levelNumber').textContent = level;
            document.getElementById('levelProgressBar').style.width = `${(ordersFilledThisLevel / ORDERS_PER_LEVEL) * 100}%`;
            document.getElementById('levelProgressText').textContent = `${ordersFilledThisLevel}/${ORDERS_PER_LEVEL} orders`;
        }

        // Show level up popup
        function showLevelUpPopup() {
            const popup = document.createElement('div');
            popup.className = 'level-up-popup';
            popup.innerHTML = `
                <div class="level-up-title">LEVEL UP!</div>
                <div class="level-up-number">${level}</div>
                <div class="level-up-info">Customers are hungrier & faster!</div>
            `;
            document.body.appendChild(popup);

            setTimeout(() => {
                popup.style.animation = 'levelUpPop 0.3s ease-in reverse';
                setTimeout(() => popup.remove(), 300);
            }, 1500);
        }

        // Check for level up
        function checkLevelUp() {
            if (ordersFilledThisLevel >= ORDERS_PER_LEVEL) {
                level++;
                ordersFilledThisLevel = 0;

                // Give 10 of each new ingredient when they unlock
                if (level === 2) {
                    inventory.creamcheese = 10;
                    inventory.pumpkin = 10;
                }
                if (level === 3) {
                    inventory.mushroom = 10;
                }
                if (level === 4) {
                    inventory.jalapeno = 10;
                    inventory.pepper = 10;
                }
                if (level === 5) {
                    inventory.ultimate = 10;
                }
                createIngredientButtons();

                updateLevelDisplay();
                showLevelUpPopup();
            }
        }

        // Generate a random order - more fillings at higher levels
        function generateOrder() {
            // Get available fillings based on level (start with base fillings only)
            let availableForOrder = ['avocado', 'cucumber', 'mango'];
            if (level >= 2) {
                availableForOrder.push('creamcheese', 'pumpkin');
            }
            if (level >= 3) {
                availableForOrder.push('mushroom');
            }
            if (level >= 4) {
                availableForOrder.push('jalapeno', 'pepper');
            }
            if (level >= 5) {
                availableForOrder.push('ultimate');
            }

            // Small chance for ultimate-only order at level 5+
            if (level >= 5 && Math.random() < 0.15) {
                return ['ultimate'];
            }

            // Remove ultimate from regular orders (it only comes alone)
            const regularFillings = availableForOrder.filter(f => f !== 'ultimate');

            // 1-3 fillings per sushi, capped at 3
            let minFillings = 1;
            let maxFillings = 3;

            // Higher levels have higher minimum
            if (level >= 3) minFillings = 2;
            if (level >= 5) minFillings = 3;

            const numFillings = Math.floor(Math.random() * (maxFillings - minFillings + 1)) + minFillings;
            const order = [];

            // At level 3+, allow duplicate fillings
            if (level >= 3) {
                for (let i = 0; i < numFillings; i++) {
                    const randomIndex = Math.floor(Math.random() * regularFillings.length);
                    order.push(regularFillings[randomIndex]);
                }
            } else {
                // Unique fillings only
                const uniqueFillings = [...regularFillings];
                for (let i = 0; i < numFillings; i++) {
                    if (uniqueFillings.length === 0) break;
                    const randomIndex = Math.floor(Math.random() * uniqueFillings.length);
                    order.push(uniqueFillings[randomIndex]);
                    uniqueFillings.splice(randomIndex, 1);
                }
            }

            return order;
        }

        // Active orders (max 3)
        let orders = [];
        const MAX_ORDERS = 3;

        // Create an order box
        function createOrderBox(orderFillings) {
            const box = document.createElement('div');
            box.style.cssText = 'position: relative; width: 100px; height: 80px; background: linear-gradient(180deg, #ffffff, #f0f0f0); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border: 2px solid #ccc; transition: all 0.2s;';

            // Store the order on the element
            box.orderFillings = orderFillings;

            // Timer settings - faster at higher levels
            // Level 1: 35s, Level 2: 32s, Level 3: 29s, etc. Min: 15s
            const orderTime = Math.max(15000, 35000 - (level - 1) * 3000);
            let timeRemaining = orderTime;
            const startTime = Date.now();

            // Timer bar
            const timerContainer = document.createElement('div');
            timerContainer.className = 'order-timer';
            const timerBar = document.createElement('div');
            timerBar.className = 'order-timer-bar';
            timerBar.style.width = '100%';
            timerContainer.appendChild(timerBar);
            box.appendChild(timerContainer);

            // Timer interval
            const timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                timeRemaining = orderTime - elapsed;
                const percent = Math.max(0, (timeRemaining / orderTime) * 100);
                timerBar.style.width = percent + '%';

                // Change color based on time remaining
                if (percent <= 20) {
                    timerBar.className = 'order-timer-bar critical';
                } else if (percent <= 50) {
                    timerBar.className = 'order-timer-bar warning';
                }

                // Time's up
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    box.classList.add('order-expired');
                    setTimeout(() => {
                        box.remove();
                        orders = orders.filter(o => o !== box);
                    }, 500);
                }
            }, 100);

            // Store interval so we can clear it if order is completed
            box.timerInterval = timerInterval;

            // Label
            const label = document.createElement('div');
            label.style.cssText = 'font-size: 9px; color: #333; margin-bottom: 5px; font-weight: bold;';
            label.textContent = 'ORDER';
            box.appendChild(label);

            // Mini sushi visual
            const sushi = document.createElement('div');
            sushi.style.cssText = 'width: 70px; height: 20px; background: linear-gradient(180deg, #1a3a1a, #2d5a2d, #1a3a1a); border-radius: 10px; position: relative;';

            // Sushi end with fillings
            const end = document.createElement('div');
            end.style.cssText = 'position: absolute; right: 0; top: 0; width: 14px; height: 20px; border-radius: 0 10px 10px 0; background: #1a3a1a; display: flex; align-items: center; justify-content: center;';

            const rice = document.createElement('div');
            rice.style.cssText = 'width: 10px; height: 14px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center;';

            const filling = document.createElement('div');
            filling.style.cssText = 'width: 6px; height: 9px; border-radius: 50%; background: ' + generatePieGradient(orderFillings) + ';';

            rice.appendChild(filling);
            end.appendChild(rice);
            sushi.appendChild(end);
            box.appendChild(sushi);

            // Fillings text
            const text = document.createElement('div');
            text.style.cssText = 'font-size: 8px; color: #555; margin-top: 5px;';
            text.textContent = orderFillings.join(', ');
            box.appendChild(text);

            // Make it a drop target
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.style.borderColor = '#4CAF50';
                box.style.transform = 'scale(1.05)';
            });

            box.addEventListener('dragleave', () => {
                box.style.borderColor = '#ccc';
                box.style.transform = 'scale(1)';
            });

            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.style.borderColor = '#ccc';
                box.style.transform = 'scale(1)';

                let sushiFillings = [];

                // Get fillings based on drag source
                if (dragSource === 'workspace') {
                    sushiFillings = [...currentSushiFillings];
                    resetGame();
                } else if (dragSource === 'bento' && draggedBentoSushi) {
                    sushiFillings = [...draggedBentoFillings];
                    draggedBentoSushi.remove();
                    bentoCount--;
                    document.getElementById('bentoCount').textContent = bentoCount + ' roll' + (bentoCount !== 1 ? 's' : '') + ' stored';
                    if (bentoCount === 0) {
                        document.getElementById('bentoEmpty').style.display = 'block';
                    }
                    draggedBentoSushi = null;
                    draggedBentoFillings = [];
                }

                // Check if order matches
                if (sushiFillings.length > 0) {
                    checkOrder(box, sushiFillings);
                }

                dragSource = null;
            });

            return box;
        }

        // Check if delivered sushi matches order
        function checkOrder(box, sushiFillings) {
            const orderFillings = box.orderFillings;
            const sortedOrder = [...orderFillings].sort();
            const sortedFillings = [...sushiFillings].sort();

            const isCorrect = sortedOrder.length === sortedFillings.length &&
                sortedOrder.every((f, i) => f === sortedFillings[i]);

            if (isCorrect) {
                // Clear the timer
                if (box.timerInterval) {
                    clearInterval(box.timerInterval);
                }

                // Pay coins based on each filling's sell price + price increase bonus
                const payment = orderFillings.reduce((sum, filling) => sum + (ingredientInfo[filling].sellPrice || 7) + priceIncreaseLevel, 0);
                coins += payment;
                document.getElementById('coinCount').textContent = coins;

                // Track orders filled for level system
                ordersFilledTotal++;
                ordersFilledThisLevel++;
                updateLevelDisplay();

                // Remove this order
                box.style.background = 'linear-gradient(180deg, #c8f7c8, #a0e0a0)';
                setTimeout(() => {
                    box.remove();
                    orders = orders.filter(o => o !== box);
                    // Check for level up after order is removed
                    checkLevelUp();
                }, 300);

                showStatus('Correct! +' + payment + ' coins!', 'success');
            } else {
                // Wrong order
                box.style.background = 'linear-gradient(180deg, #f7c8c8, #e0a0a0)';
                setTimeout(() => {
                    box.style.background = 'linear-gradient(180deg, #ffffff, #f0f0f0)';
                }, 300);
                showStatus('Wrong order! Check the fillings.', 'fail');
            }
        }

        // Add a new order
        function addOrder() {
            if (orders.length >= MAX_ORDERS) {
                return;
            }

            const orderFillings = generateOrder();
            const box = createOrderBox(orderFillings);
            orders.push(box);
            document.getElementById('orderRow').appendChild(box);
        }

        // Call customer function - adds an order
        function callCustomer() {
            addOrder();
            showStatus('New order!', 'success');
        }

        // Schedule next order with random delay - faster at higher levels
        function scheduleNextOrder() {
            // Base: 7-15 seconds, decreases with level
            // Level 1: 7-15s, Level 2: 6-13s, Level 3: 5-11s, etc.
            // Minimum: 2-4 seconds at high levels
            const baseMin = Math.max(2000, 7000 - (level - 1) * 1000);
            const baseMax = Math.max(4000, 15000 - (level - 1) * 2000);
            const delay = baseMin + Math.random() * (baseMax - baseMin);

            setTimeout(() => {
                if (orders.length < MAX_ORDERS) {
                    addOrder();
                }
                scheduleNextOrder(); // Schedule the next one
            }, delay);
        }

        // Get ingredients needed from current orders
        function getNeededIngredients() {
            const needed = { rice: 0 };
            orders.forEach(order => {
                needed.rice++; // Each order needs rice
                order.orderFillings.forEach(filling => {
                    needed[filling] = (needed[filling] || 0) + 1;
                });
            });
            return needed;
        }

        // Count available cooked rice
        function countCookedRice() {
            let count = 0;
            for (let i = 1; i <= numRiceCookers; i++) {
                const output = document.getElementById(`cookedRiceOutput${i}`);
                if (output) count += output.children.length;
            }
            return count;
        }

        // Count available chopped ingredient
        function countChoppedIngredient(ingredient) {
            let count = 0;
            for (let i = 1; i <= numChoppingBoards; i++) {
                const output = document.getElementById(`choppedOutput${i}`);
                if (output) {
                    const chips = output.querySelectorAll(`.${ingredient}`);
                    count += chips.length;
                }
            }
            return count;
        }

        // Auto-process ingredients
        function autoProcess() {
            const needed = getNeededIngredients();

            // Auto cooker logic - upgrades allow processing more per cycle
            if (hasAutoCooker) {
                const cookedRice = countCookedRice();
                const riceNeeded = needed.rice - cookedRice;
                const maxCooksPerCycle = 1 + autoCookerLevel; // Level 1 = 1, Level 2 = 2, etc.

                for (let i = 0; i < maxCooksPerCycle && riceNeeded > i && inventory.rice > 0; i++) {
                    const availableCooker = riceCookerBusy.findIndex(busy => !busy);
                    if (availableCooker !== -1) {
                        inventory.rice--;
                        createIngredientButtons();
                        startCookingRice(availableCooker + 1);
                    } else {
                        break; // No more available cookers
                    }
                }
            }

            // Auto chopper logic - upgrades allow processing more per cycle
            if (hasAutoChopper) {
                const choppableFillings = ['avocado', 'cucumber', 'mango', 'pumpkin', 'mushroom', 'jalapeno', 'pepper', 'ultimate'];
                const maxChopsPerCycle = 1 + autoChopperLevel; // Level 1 = 1, Level 2 = 2, etc.
                let chopsThisCycle = 0;

                for (const filling of choppableFillings) {
                    if (chopsThisCycle >= maxChopsPerCycle) break;

                    if (needed[filling] && needed[filling] > 0) {
                        const chopped = countChoppedIngredient(filling);
                        const fillingNeeded = needed[filling] - chopped;

                        if (fillingNeeded > 0 && inventory[filling] > 0) {
                            const availableBoard = choppingBoardBusy.findIndex(busy => !busy);
                            if (availableBoard !== -1) {
                                inventory[filling]--;
                                createIngredientButtons();
                                startChopping(filling, availableBoard + 1);
                                chopsThisCycle++;
                            }
                        }
                    }
                }
            }

            // Auto assembler logic - upgrades allow assembling more per cycle
            if (hasAutoAssembler && orders.length > 0) {
                const maxAssemblesPerCycle = 1 + autoAssemblerLevel; // Level 1 = 1, Level 2 = 2, etc.
                let assemblesThisCycle = 0;

                // Check if workspace is clear (no sushi being made manually)
                const rolledSushiEl = document.getElementById('rolledSushi');
                const isWorkspaceClear = layers.length === 0 &&
                    rolledSushiEl &&
                    (rolledSushiEl.style.display === 'none' || rolledSushiEl.style.display === '');

                if (isWorkspaceClear) {
                    // Find orders we can fulfill
                    const ordersCopy = [...orders];
                    for (const order of ordersCopy) {
                        if (assemblesThisCycle >= maxAssemblesPerCycle) break;
                        if (!order || !order.orderFillings) continue;
                        if (order.beingProcessed) continue; // Skip orders already being processed

                        const orderFillings = order.orderFillings;

                        // Check if we have all base ingredients
                        if (inventory.seaweed <= 0) continue;
                        if (countCookedRice() <= 0) continue;

                        // Count how many of each filling we need
                        const fillingCounts = {};
                        for (const filling of orderFillings) {
                            fillingCounts[filling] = (fillingCounts[filling] || 0) + 1;
                        }

                        let hasAllFillings = true;
                        for (const [filling, count] of Object.entries(fillingCounts)) {
                            if (filling === 'creamcheese') {
                                // Cream cheese comes from inventory directly
                                if (inventory.creamcheese < count) {
                                    hasAllFillings = false;
                                    break;
                                }
                            } else {
                                // Other fillings need to be chopped
                                if (countChoppedIngredient(filling) < count) {
                                    hasAllFillings = false;
                                    break;
                                }
                            }
                        }

                        if (hasAllFillings) {
                            // Assemble the sushi!
                            autoAssembleSushi(order, orderFillings);
                            assemblesThisCycle++;
                        }
                    }
                }
            }
        }

        // Auto-assemble and deliver sushi
        function autoAssembleSushi(order, orderFillings) {
            // Mark order as being processed to prevent double-processing
            if (order.beingProcessed) return;
            order.beingProcessed = true;

            // Add seaweed
            inventory.seaweed--;
            createIngredientButtons();
            layers.push('seaweed');

            // Add rice (consume from first available cooker)
            for (let i = 1; i <= numRiceCookers; i++) {
                const output = document.getElementById(`cookedRiceOutput${i}`);
                if (output && output.children.length > 0) {
                    output.removeChild(output.children[0]);
                    break;
                }
            }
            layers.push('rice');

            // Add fillings
            for (const filling of orderFillings) {
                if (filling === 'creamcheese') {
                    // Consume from inventory
                    inventory.creamcheese--;
                    createIngredientButtons();
                } else {
                    // Consume from chopped outputs
                    for (let i = 1; i <= numChoppingBoards; i++) {
                        const output = document.getElementById(`choppedOutput${i}`);
                        if (output) {
                            const chip = output.querySelector(`.${filling}`);
                            if (chip) {
                                chip.remove();
                                break;
                            }
                        }
                    }
                }
                layers.push(filling);
            }

            // Now fulfill the order directly
            autoFulfillOrder(order, orderFillings);

            // Reset layers
            layers = [];
        }

        // Automatically fulfill an order
        function autoFulfillOrder(box, sushiFillings) {
            // Clear the timer
            if (box.timerInterval) {
                clearInterval(box.timerInterval);
            }

            // Pay coins based on each filling's sell price + price increase bonus
            const payment = sushiFillings.reduce((sum, filling) => {
                return sum + (ingredientInfo[filling].sellPrice || 7) + priceIncreaseLevel;
            }, 0);
            coins += payment;
            document.getElementById('coinCount').textContent = coins;

            // Track orders filled for level system
            ordersFilledTotal++;
            ordersFilledThisLevel++;
            updateLevelDisplay();

            // Remove this order
            box.style.background = 'linear-gradient(180deg, #c8f7c8, #a0e0a0)';
            box.style.transform = 'scale(1.1)';

            setTimeout(() => {
                box.remove();
                const index = orders.indexOf(box);
                if (index > -1) {
                    orders.splice(index, 1);
                }
            }, 300);

            showStatus(`+${payment} coins! (Auto)`, 'success');
        }

        // Initialize with one order and start auto-spawning
        function startGame() {
            initBusyArrays();
            renderPrepStations();
            createIngredientButtons();
            setupPrepStations();
            updateLevelDisplay();
            addOrder();
            scheduleNextOrder();

            // Start auto-processing interval
            setInterval(autoProcess, 500);
        }

        // Only start once
        let gameStarted = false;
        function initGame() {
            if (gameStarted) return;
            gameStarted = true;
            startGame();
        }

        // Start the game
        initGame();
    </script>
</body>
</html>
